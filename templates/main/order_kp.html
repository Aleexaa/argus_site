{% extends 'base.html' %}
{% load static %}

{% block title %}–ó–∞–∫–∞–∑–∞—Ç—å –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ{% endblock %}

{% block content %}
<div class="min-h-screen py-12 md:py-20 bg-white">
  <div class="container mx-auto px-4">

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="text-center mb-12">
      <h1 class="text-3xl md:text-5xl text-dark-blue mb-4 font-bold">–ó–∞–∫–∞–∑–∞—Ç—å –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</h1>
      <p class="text-lg text-gray-600 max-w-3xl mx-auto">
        –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –ö–ü.  
        –ü–æ–ª—è, –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ <span class="text-red-500">*</span>, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.
      </p>
    </div>

    <!-- –§–æ—Ä–º–∞ -->
    <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
      <form id="kpForm" method="post" action="{% url 'order_kp' %}" enctype="multipart/form-data" novalidate class="space-y-6">
        {% csrf_token %}

        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ -->
        <div>
          <label for="company_name" class="block text-dark-blue mb-2 font-medium">
            –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ <span class="text-red-500">*</span>
          </label>
          <input type="text" id="company_name" name="company_name" placeholder="–û–û–û –ü—Ä–∏–º–µ—Ä"
                 class="form-input" required minlength="2" maxlength="100" value="{{ form.company_name.value|default:'' }}">
          <p class="error-text hidden" id="company_name_error">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)</p>
        </div>

        <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ -->
        <div>
          <label for="contact_person" class="block text-dark-blue mb-2 font-medium">
            –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ <span class="text-red-500">*</span>
          </label>
          <input type="text" id="contact_person" name="contact_person" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"
                 class="form-input" required minlength="2" maxlength="100" value="{{ form.contact_person.value|default:'' }}">
          <p class="error-text hidden" id="contact_person_error">–í–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)</p>
        </div>

        <!-- –¢–µ–ª–µ—Ñ–æ–Ω –∏ Email -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="phone" class="block text-dark-blue mb-2 font-medium">
              –¢–µ–ª–µ—Ñ–æ–Ω <span class="text-red-500">*</span>
            </label>
            <input type="tel" id="phone" name="phone" placeholder="+7 (999) 123-45-67"
                   class="form-input" required value="{{ form.phone.value|default:'' }}">
            <p class="error-text hidden" id="phone_error">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</p>
          </div>

          <div>
            <label for="email" class="block text-dark-blue mb-2 font-medium">
              Email <span class="text-red-500">*</span>
            </label>
            <input type="email" id="email" name="email" placeholder="example@company.ru"
                   class="form-input" required value="{{ form.email.value|default:'' }}">
            <p class="error-text hidden" id="email_error">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Email</p>
          </div>
        </div>

        <!-- –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞ -->
        <div>
          <label for="object_type" class="block text-dark-blue mb-2 font-medium">
            –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞ <span class="text-red-500">*</span>
          </label>
          <select id="object_type" name="object_type" class="form-input" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞</option>
            <option value="residential" {% if form.object_type.value == 'residential' %}selected{% endif %}>–ñ–∏–ª–æ–µ –∑–¥–∞–Ω–∏–µ</option>
            <option value="industrial" {% if form.object_type.value == 'industrial' %}selected{% endif %}>–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç</option>
            <option value="commercial" {% if form.object_type.value == 'commercial' %}selected{% endif %}>–¢–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä</option>
            <option value="office" {% if form.object_type.value == 'office' %}selected{% endif %}>–û—Ñ–∏—Å</option>
            <option value="government" {% if form.object_type.value == 'government' %}selected{% endif %}>–ì–æ—Å. —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ</option>
            <option value="other" {% if form.object_type.value == 'other' %}selected{% endif %}>–î—Ä—É–≥–æ–µ</option>
          </select>
          <p class="error-text hidden" id="object_type_error">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞</p>
        </div>

        <!-- –ê–¥—Ä–µ—Å -->
        <div>
          <label for="object_address" class="block text-dark-blue mb-2 font-medium">
            –ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞
          </label>
          <textarea id="object_address" name="object_address" rows="2"
                    placeholder="–≥. –ö–∞–∑–∞–Ω—å, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 10"
                    class="form-input" maxlength="200">{{ form.object_address.value|default:'' }}</textarea>
          <div class="text-right text-sm text-gray-500 mt-1">
            <span id="address_counter">0</span>/200 —Å–∏–º–≤–æ–ª–æ–≤
          </div>
        </div>

        <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
        <div>
          <label for="description" class="block text-dark-blue mb-2 font-medium">
            üìù –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
          </label>
          <textarea id="description" name="description" rows="4"
                    placeholder="–û–ø–∏—à–∏—Ç–µ –æ–±—ä–µ–∫—Ç, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, –ø–æ–∂–µ–ª–∞–Ω–∏—è..."
                    class="form-input" maxlength="1000">{{ form.description.value|default:'' }}</textarea>
          <div class="text-right text-sm text-gray-500 mt-1">
            <span id="description_counter">0</span>/1000 —Å–∏–º–≤–æ–ª–æ–≤
          </div>
        </div>

        <!-- –£—Å–ª—É–≥–∏ -->
        <div>
          <label class="block text-dark-blue mb-3 font-medium">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥–∏ <span class="text-red-500">*</span></label>
          <div class="space-y-2" id="services_container">
            {% for service in services %}
              <label class="flex items-center space-x-3 p-2 rounded hover:bg-gray-50 transition-colors">
                <input type="checkbox" name="services" value="{{ service.id }}"
                       class="rounded border-gray-300 text-gold focus:ring-gold service-checkbox"
                       {% if service.id in selected_services %}checked{% endif %}>
                <span class="text-gray-700">{{ service.name }}</span>
              </label>
            {% empty %}
              <p class="text-gray-500">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥</p>
            {% endfor %}
          </div>
          <p class="error-text hidden" id="services_error">–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —É—Å–ª—É–≥—É</p>
        </div>

        <!-- –§–∞–π–ª -->
        <div>
          <label class="block text-dark-blue mb-2 font-medium">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</label>
          <div id="file-drop" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-gold transition">
            <input type="file" id="fileInput" name="attached_file" class="hidden" 
                   accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png,.zip,.rar" 
                   data-max-size="10485760">
            <div id="fileContent">
              <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
              </svg>
              <p id="fileLabel" class="text-gray-500 mb-1">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
              <p class="text-xs text-gray-400">PDF, DOC, XLS, JPG, PNG –¥–æ 10MB</p>
            </div>
            <div id="filePreview" class="hidden">
              <div class="flex items-center justify-between bg-gray-50 rounded-lg p-3">
                <div class="flex items-center space-x-3">
                  <svg class="w-8 h-8 text-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                  </svg>
                  <div>
                    <p id="fileName" class="text-gray-700 font-medium text-sm"></p>
                    <p id="fileSize" class="text-gray-500 text-xs"></p>
                  </div>
                </div>
                <button type="button" id="removeFileBtn" class="text-red-500 hover:text-red-700 transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          <p class="error-text hidden" id="file_error"></p>
        </div>

        <!-- ‚úÖ –ë–õ–û–ö –°–û–ì–õ–ê–°–ò–Ø –ù–ê –û–ë–†–ê–ë–û–¢–ö–£ –ü–ï–†–°–û–ù–ê–õ–¨–ù–´–• –î–ê–ù–ù–´–• -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
          <div class="flex items-start space-x-3">
            <input type="checkbox" id="pd_agreed" name="pd_agreed" required
                   class="mt-1 rounded border-gray-300 text-gold focus:ring-gold"
                   {% if form.pd_agreed.value %}checked{% endif %}>
            <div>
              <label for="pd_agreed" class="block text-dark-blue font-medium mb-1">
                –°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö <span class="text-red-500">*</span>
              </label>
              <p class="text-sm text-gray-600">
                –Ø –¥–∞—é —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –º–æ–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å 
                <a href="{% url 'privacy_policy' %}" target="_blank" class="text-gold hover:text-amber-600 underline">
                  –ü–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏
                </a> 
                –∏ –ø—Ä–∏–Ω–∏–º–∞—é 
                <a href="{% url 'terms' %}" target="_blank" class="text-gold hover:text-amber-600 underline">
                  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ
                </a>.
                –°–æ–≥–ª–∞—Å–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–æ–∑–≤–∞–Ω–æ –º–Ω–æ–π –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç –ø—É—Ç–µ–º –ø–∏—Å—å–º–µ–Ω–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.
              </p>
            </div>
          </div>
          <p class="error-text hidden mt-2" id="pd_agreed_error">
            –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
          </p>
        </div>

        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è -->
        <div class="bg-gray-50 rounded-lg p-4">
          <div class="flex justify-between items-center mb-2">
            <span class="text-sm font-medium text-dark-blue">–ó–∞–ø–æ–ª–Ω–µ–Ω–æ —Ñ–æ—Ä–º—ã:</span>
            <span id="progressPercent" class="text-sm font-bold text-gold">0%</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="progressBar" class="bg-gold h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
          </div>
        </div>

        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö Django -->
        {% if messages %}
        <div class="mb-6">
          {% for message in messages %}
            <div class="p-4 rounded-lg {% if message.tags == 'error' %}bg-red-50 text-red-700 border border-red-200{% else %}bg-green-50 text-green-700 border border-green-200{% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- –û—Ç–ø—Ä–∞–≤–∏—Ç—å -->
        <button type="submit" id="submitBtn"
                class="w-full bg-gold hover:bg-amber-600 text-white py-4 rounded-lg transition-all duration-300 font-medium text-lg disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center space-x-2">
          <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</span>
          <svg id="submitSpinner" class="w-5 h-5 hidden animate-spin" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </button>

        <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ -->
        <div id="successMessage" class="hidden bg-green-50 border border-green-200 rounded-lg p-4 text-green-700">
          <div class="flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <span class="font-medium">–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!</span>
          </div>
          <p class="text-sm mt-1">–ú—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.</p>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ===== CSS —Å—Ç–∏–ª–∏ ===== -->
<style>
.form-input {
  width: 100%;
  border: 1px solid #d1d5db;
  border-radius: 0.5rem;
  padding: 0.75rem 1rem;
  outline: none;
  transition: border 0.2s, box-shadow 0.2s;
}
.form-input:focus {
  border-color: #C9A96A;
  box-shadow: 0 0 0 3px rgba(201,169,106,0.2);
}
.form-input.error {
  border-color: #dc2626 !important;
  box-shadow: 0 0 0 3px rgba(220,38,38,0.1);
}
.error-text {
  font-size: 0.875rem;
  color: #dc2626;
  margin-top: 0.25rem;
}
#file-drop.dragover {
  border-color: #C9A96A;
  background-color: rgba(201,169,106,0.05);
}
#file-drop.error {
  border-color: #dc2626;
}
.progress-complete {
  background-color: #10b981 !important;
}
</style>

<!-- ===== JS –≤–∞–ª–∏–¥–∞—Ü–∏—è –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è ===== -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // –û—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
  const form = document.getElementById('kpForm');
  const submitBtn = document.getElementById('submitBtn');
  const submitSpinner = document.getElementById('submitSpinner');
  const successMessage = document.getElementById('successMessage');
  const progressBar = document.getElementById('progressBar');
  const progressPercent = document.getElementById('progressPercent');

  // –ï—Å–ª–∏ —Ñ–æ—Ä–º–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –≤—ã—Ö–æ–¥–∏–º
  if (!form) return;

  // –ü—Ä–æ—Å—Ç–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –æ—à–∏–±–æ–∫
  function getErrorElement(fieldName) {
    return document.getElementById(fieldName + '_error');
  }

  // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –º–∞—Å–∫–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
  let lastPhoneValue = '';

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
  initForm();

  function initForm() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
    updateCounter('object_address');
    updateCounter('description');

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    setupEventListeners();
    setupFileUpload();
    calculateProgress();

    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —Å —É–º–Ω–æ–π –º–∞—Å–∫–æ–π
    initPhoneMask();
  }

  function setupEventListeners() {
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –ø–æ–ª–µ–π
    const textFields = ['company_name', 'contact_person', 'phone', 'email', 'object_type', 'object_address', 'description'];
    textFields.forEach(fieldName => {
      const field = document.getElementById(fieldName);
      if (field) {
        field.addEventListener('input', () => {
          validateField(fieldName);
          calculateProgress();
          if (fieldName === 'object_address' || fieldName === 'description') {
            updateCounter(fieldName);
          }
        });
        field.addEventListener('blur', () => validateField(fieldName));
      }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ —É—Å–ª—É–≥
    const serviceCheckboxes = document.querySelectorAll('.service-checkbox');
    serviceCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        validateField('services');
        calculateProgress();
      });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ–≥–ª–∞—Å–∏—è
    const pdAgreed = document.getElementById('pd_agreed');
    if (pdAgreed) {
      pdAgreed.addEventListener('change', () => {
        validateField('pd_agreed');
        calculateProgress();
      });
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
    form.addEventListener('submit', handleFormSubmit);
  }

  function setupFileUpload() {
    const fileDrop = document.getElementById('file-drop');
    const fileInput = document.getElementById('fileInput');
    const fileContent = document.getElementById('fileContent');
    const filePreview = document.getElementById('filePreview');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const removeFileBtn = document.getElementById('removeFileBtn');

    if (!fileDrop || !fileInput) return;

    fileDrop.addEventListener('click', () => fileInput.click());

    // Drag & Drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      fileDrop.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      fileDrop.addEventListener(eventName, () => fileDrop.classList.add('dragover'), false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      fileDrop.addEventListener(eventName, () => fileDrop.classList.remove('dragover'), false);
    });

    fileDrop.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
      const files = e.dataTransfer.files;
      if (files.length) handleFiles(files[0]);
    }

    fileInput.addEventListener('change', () => {
      if (fileInput.files.length) handleFiles(fileInput.files[0]);
    });

    if (removeFileBtn) {
      removeFileBtn.addEventListener('click', resetFileInput);
    }

    function handleFiles(file) {
      const maxSize = 10485760; // 10MB
      
      if (file.size > maxSize) {
        showFileError(`–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: ${formatFileSize(maxSize)}`);
        return;
      }

      const acceptedTypes = ['.pdf','.doc','.docx','.xls','.xlsx','.jpg','.jpeg','.png','.zip','.rar'];
      const isValidType = acceptedTypes.some(type => file.name.toLowerCase().endsWith(type));
      
      if (!isValidType) {
        showFileError('–ù–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞');
        return;
      }

      hideFileError();
      if (fileName) fileName.textContent = file.name;
      if (fileSize) fileSize.textContent = formatFileSize(file.size);
      if (fileContent) fileContent.classList.add('hidden');
      if (filePreview) filePreview.classList.remove('hidden');
      calculateProgress();
    }

    function resetFileInput() {
      if (fileInput) fileInput.value = '';
      if (fileContent) fileContent.classList.remove('hidden');
      if (filePreview) filePreview.classList.add('hidden');
      hideFileError();
      calculateProgress();
    }

    function showFileError(message) {
      const errorElement = getErrorElement('file');
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.classList.remove('hidden');
        fileDrop.classList.add('error');
      }
    }

    function hideFileError() {
      const errorElement = getErrorElement('file');
      if (errorElement) {
        errorElement.classList.add('hidden');
        fileDrop.classList.remove('error');
      }
    }
  }

  function initPhoneMask() {
    const phoneInput = document.getElementById('phone');
    if (!phoneInput) return;
    
    phoneInput.addEventListener('input', function(e) {
      const input = e.target;
      const originalValue = input.value.replace(/\D/g, '');
      
      const isDeletion = input.value.length < lastPhoneValue.length;
      const cursorPosition = input.selectionStart;
      
      let formattedValue = '';
      
      if (originalValue === '' || originalValue === '7' || originalValue === '8') {
        formattedValue = '+7';
      } else if (originalValue.length <= 1) {
        formattedValue = `+7 (${originalValue}`;
      } else if (originalValue.length <= 4) {
        formattedValue = `+7 (${originalValue.substring(1, 4)}`;
      } else if (originalValue.length <= 7) {
        formattedValue = `+7 (${originalValue.substring(1, 4)}) ${originalValue.substring(4, 7)}`;
      } else if (originalValue.length <= 9) {
        formattedValue = `+7 (${originalValue.substring(1, 4)}) ${originalValue.substring(4, 7)}-${originalValue.substring(7, 9)}`;
      } else {
        formattedValue = `+7 (${originalValue.substring(1, 4)}) ${originalValue.substring(4, 7)}-${originalValue.substring(7, 9)}-${originalValue.substring(9, 11)}`;
      }
      
      input.value = formattedValue;
      lastPhoneValue = formattedValue;
      
      if (isDeletion) {
        let newCursorPosition = cursorPosition;
        if (cursorPosition > 0 && [' ', '(', ')', '-'].includes(lastPhoneValue.charAt(cursorPosition - 1))) {
          newCursorPosition = cursorPosition - 1;
        }
        input.setSelectionRange(newCursorPosition, newCursorPosition);
      }
    });
  }

  function validateField(fieldName) {
    const field = document.getElementById(fieldName);
    const errorElement = getErrorElement(fieldName);
    
    if (!field || !errorElement) return true;

    let isValid = true;
    let errorMessage = '';

    switch (fieldName) {
      case 'company_name':
      case 'contact_person':
        isValid = field.value.trim().length >= 2;
        errorMessage = `–í–≤–µ–¥–∏—Ç–µ ${fieldName === 'company_name' ? '–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏' : '–∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ'} (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)`;
        break;
      
      case 'phone':
        const phoneValue = field.value.replace(/\D/g, '');
        isValid = phoneValue.length === 11 && (phoneValue.startsWith('7') || phoneValue.startsWith('8'));
        errorMessage = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞';
        break;
      
      case 'email':
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        isValid = emailPattern.test(field.value.trim());
        errorMessage = '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Email';
        break;
      
      case 'object_type':
        isValid = field.value !== '';
        errorMessage = '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞';
        break;
      
      case 'services':
        const checkedServices = document.querySelectorAll('.service-checkbox:checked');
        isValid = checkedServices.length > 0;
        errorMessage = '–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —É—Å–ª—É–≥—É';
        break;
      
      case 'pd_agreed':
        isValid = field.checked;
        errorMessage = '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö';
        break;
    }

    // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    if (!isValid) {
      field.classList.add('error');
      errorElement.textContent = errorMessage;
      errorElement.classList.remove('hidden');
    } else {
      field.classList.remove('error');
      errorElement.classList.add('hidden');
    }

    return isValid;
  }

  function validateAllFields() {
    const requiredFields = ['company_name', 'contact_person', 'phone', 'email', 'object_type', 'services', 'pd_agreed'];
    let allValid = true;

    requiredFields.forEach(fieldName => {
      if (!validateField(fieldName)) {
        allValid = false;
      }
    });

    return allValid;
  }

  function calculateProgress() {
    const requiredFields = ['company_name', 'contact_person', 'phone', 'email', 'object_type', 'services', 'pd_agreed'];
    let completed = 0;

    requiredFields.forEach(fieldName => {
      const field = document.getElementById(fieldName);
      if (!field) return;

      if (fieldName === 'services') {
        const checkedServices = document.querySelectorAll('.service-checkbox:checked');
        if (checkedServices.length > 0) completed++;
      } else if (fieldName === 'pd_agreed') {
        if (field.checked) completed++;
      } else if (field.value.trim() !== '') {
        completed++;
      }
    });

    // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è
    const optionalFields = ['object_address', 'description'];
    optionalFields.forEach(fieldName => {
      const field = document.getElementById(fieldName);
      if (field && field.value.trim() !== '') {
        completed += 0.5;
      }
    });

    // –§–∞–π–ª
    const fileInput = document.getElementById('fileInput');
    if (fileInput && fileInput.files.length > 0) {
      completed += 0.5;
    }

    const total = requiredFields.length + (optionalFields.length * 0.5) + 0.5;
    const progress = Math.round((completed / total) * 100);

    if (progressBar) progressBar.style.width = `${progress}%`;
    if (progressPercent) progressPercent.textContent = `${progress}%`;

    if (progress === 100 && progressBar) {
      progressBar.classList.add('progress-complete');
    } else if (progressBar) {
      progressBar.classList.remove('progress-complete');
    }
  }

  function updateCounter(fieldName) {
    const field = document.getElementById(fieldName);
    const counter = document.getElementById(fieldName + '_counter');
    
    if (field && counter) {
      counter.textContent = field.value.length;
    }
  }

  async function handleFormSubmit(e) {
    e.preventDefault();
    
    if (!validateAllFields()) {
      showNotification('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ', 'error');
      return;
    }

    // –ü–æ–∫–∞–∑ –∑–∞–≥—Ä—É–∑–∫–∏
    if (submitBtn) {
      submitBtn.disabled = true;
      const span = submitBtn.querySelector('span');
      if (span) span.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
    }
    if (submitSpinner) submitSpinner.classList.remove('hidden');

    try {
      const formData = new FormData(form);
      
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      });

      if (response.ok) {
        if (successMessage) successMessage.classList.remove('hidden');
        form.reset();
        resetFileInput();
        calculateProgress();
        showNotification('–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!', 'success');
        
        if (successMessage) successMessage.scrollIntoView({ behavior: 'smooth' });
        
        setTimeout(() => {
          window.location.href = "{% url 'order_success' %}";
        }, 2000);
      } else {
        throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
      }
      
    } catch (error) {
      showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
    } finally {
      if (submitBtn) {
        submitBtn.disabled = false;
        const span = submitBtn.querySelector('span');
        if (span) span.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É';
      }
      if (submitSpinner) submitSpinner.classList.add('hidden');
    }
  }

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  }

  function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white font-medium ${
      type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.remove();
    }, 5000);
  }

  function resetFileInput() {
    const fileInput = document.getElementById('fileInput');
    const fileContent = document.getElementById('fileContent');
    const filePreview = document.getElementById('filePreview');
    
    if (fileInput) fileInput.value = '';
    if (fileContent) fileContent.classList.remove('hidden');
    if (filePreview) filePreview.classList.add('hidden');
    
    const errorElement = getErrorElement('file');
    if (errorElement) errorElement.classList.add('hidden');
    
    const fileDrop = document.getElementById('file-drop');
    if (fileDrop) fileDrop.classList.remove('error');
  }
});
</script>   
{% endblock %}