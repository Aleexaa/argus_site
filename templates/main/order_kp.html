{% extends 'base.html' %}
{% load static %}

{% block title %}–ó–∞–∫–∞–∑–∞—Ç—å –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ{% endblock %}

{% block content %}
<div class="min-h-screen py-12 md:py-20 bg-white">
  <div class="container mx-auto px-4">

    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
    <div class="text-center mb-12">
      <h1 class="text-3xl md:text-5xl text-dark-blue mb-4 font-bold">–ó–∞–∫–∞–∑–∞—Ç—å –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</h1>
      <p class="text-lg text-gray-600 max-w-3xl mx-auto">
        –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ –ö–ü.  
        –ü–æ–ª—è, –æ—Ç–º–µ—á–µ–Ω–Ω—ã–µ <span class="text-red-500">*</span>, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è.
      </p>
    </div>

    <!-- –§–æ—Ä–º–∞ -->
    <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8">
      <form id="kpForm" method="post" enctype="multipart/form-data" novalidate class="space-y-6">
        {% csrf_token %}

        <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ -->
        <div>
          <label for="company_name" class="block text-dark-blue mb-2 font-medium">
            –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ <span class="text-red-500">*</span>
          </label>
          <input type="text" id="company_name" name="company_name" placeholder="–û–û–û –ü—Ä–∏–º–µ—Ä"
                 class="form-input" required>
          <p class="error-text hidden">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏</p>
        </div>

        <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ -->
        <div>
          <label for="contact_person" class="block text-dark-blue mb-2 font-medium">
            –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ <span class="text-red-500">*</span>
          </label>
          <input type="text" id="contact_person" name="contact_person" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"
                 class="form-input" required>
          <p class="error-text hidden">–í–≤–µ–¥–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</p>
        </div>

        <!-- –¢–µ–ª–µ—Ñ–æ–Ω –∏ Email -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="phone" class="block text-dark-blue mb-2 font-medium">
              –¢–µ–ª–µ—Ñ–æ–Ω <span class="text-red-500">*</span>
            </label>
            <input type="tel" id="phone" name="phone" placeholder="+7 (999) 123-45-67"
                   class="form-input" required pattern="^(\+7|8)\s?\(?\d{3}\)?\s?\d{3}[- ]?\d{2}[- ]?\d{2}$">
            <p class="error-text hidden">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</p>
          </div>

          <div>
            <label for="email" class="block text-dark-blue mb-2 font-medium">
              Email <span class="text-red-500">*</span>
            </label>
            <input type="email" id="email" name="email" placeholder="example@company.ru"
                   class="form-input" required>
            <p class="error-text hidden">–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Email</p>
          </div>
        </div>

        <!-- –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞ -->
        <div>
          <label for="object_type" class="block text-dark-blue mb-2 font-medium">
            –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞ <span class="text-red-500">*</span>
          </label>
          <select id="object_type" name="object_type" class="form-input" required>
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞</option>
            <option value="residential">–ñ–∏–ª–æ–µ –∑–¥–∞–Ω–∏–µ</option>
            <option value="industrial">–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç</option>
            <option value="commercial">–¢–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä</option>
            <option value="office">–û—Ñ–∏—Å</option>
            <option value="government">–ì–æ—Å. —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ</option>
          </select>
          <p class="error-text hidden">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞</p>
        </div>

        <!-- –ê–¥—Ä–µ—Å -->
        <div>
          <label for="object_address" class="block text-dark-blue mb-2 font-medium">
            –ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞
          </label>
          <textarea id="object_address" name="object_address" rows="2"
                    placeholder="–≥. –ö–∞–∑–∞–Ω—å, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 10"
                    class="form-input"></textarea>
        </div>

        <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
        <div>
          <label for="description" class="block text-dark-blue mb-2 font-medium">
            üìù –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
          </label>
          <textarea id="description" name="description" rows="4"
                    placeholder="–û–ø–∏—à–∏—Ç–µ –æ–±—ä–µ–∫—Ç, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, –ø–æ–∂–µ–ª–∞–Ω–∏—è..."
                    class="form-input"></textarea>
        </div>

        <!-- –£—Å–ª—É–≥–∏ -->
        <div>
          <label class="block text-dark-blue mb-3 font-medium">–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥–∏ <span class="text-red-500">*</span></label>
          <div class="space-y-2">
            {% for service in services %}
              <label class="flex items-center space-x-3">
                <input type="checkbox" name="services" value="{{ service.id }}"
                       class="rounded border-gray-300 text-gold focus:ring-gold">
                <span class="text-gray-700">{{ service.name }}</span>
              </label>
            {% endfor %}
          </div>
          <p class="error-text hidden">–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —É—Å–ª—É–≥—É</p>
        </div>

        <!-- –§–∞–π–ª -->
        <div>
          <label class="block text-dark-blue mb-2 font-medium">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</label>
          <div id="file-drop" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-gold transition">
            <input type="file" id="fileInput" name="attached_file" class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx">
            <p id="fileLabel" class="text-gray-500">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
            <p id="fileName" class="text-gray-700 mt-2 font-medium hidden"></p>
            <button type="button" id="removeFileBtn" class="text-red-500 mt-2 hidden hover:underline text-sm">–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª</button>
          </div>
        </div>

        <!-- –û—Ç–ø—Ä–∞–≤–∏—Ç—å -->
        <button type="submit"
                class="w-full bg-gold hover:bg-amber-600 text-white py-4 rounded-lg transition-colors font-medium text-lg">
          –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É
        </button>
      </form>
    </div>
  </div>
</div>

<!-- ===== CSS —Å—Ç–∏–ª–∏ ===== -->
<style>
.form-input {
  width: 100%;
  border: 1px solid #d1d5db;
  border-radius: 0.5rem;
  padding: 0.75rem 1rem;
  outline: none;
  transition: border 0.2s, box-shadow 0.2s;
}
.form-input:focus {
  border-color: #C9A96A;
  box-shadow: 0 0 0 3px rgba(201,169,106,0.2);
}
.error-text {
  font-size: 0.875rem;
  color: #dc2626;
}
input.error, select.error, textarea.error {
  border-color: #dc2626 !important;
}
</style>

<!-- ===== JS –≤–∞–ª–∏–¥–∞—Ü–∏—è ===== -->
<script>
document.getElementById('kpForm').addEventListener('submit', function(e) {
  let valid = true;
  document.querySelectorAll('.error-text').forEach(el => el.classList.add('hidden'));
  document.querySelectorAll('.form-input').forEach(el => el.classList.remove('error'));

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
  ['company_name', 'contact_person', 'phone', 'email', 'object_type'].forEach(id => {
    const field = document.getElementById(id);
    if (!field.value.trim()) {
      showError(field, "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–æ –ø–æ–ª–µ");
      valid = false;
    }
  });

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
  const phone = document.getElementById('phone');
  const phonePattern = /^(\+7|8)\s?\(?\d{3}\)?\s?\d{3}[- ]?\d{2}[- ]?\d{2}$/;
  if (phone.value && !phonePattern.test(phone.value)) {
    showError(phone, "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞");
    valid = false;
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ email
  const email = document.getElementById('email');
  const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (email.value && !emailPattern.test(email.value)) {
    showError(email, "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Email");
    valid = false;
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥–∏
  const checkedServices = document.querySelectorAll('input[name="services"]:checked');
  if (checkedServices.length === 0) {
    const serviceError = document.querySelector('p.error-text:last-of-type');
    serviceError.classList.remove('hidden');
    valid = false;
  }

  if (!valid) e.preventDefault();
});

function showError(field, message) {
  field.classList.add('error');
  const errorText = field.parentElement.querySelector('.error-text');
  if (errorText) {
    errorText.textContent = "‚ö† " + message;
    errorText.classList.remove('hidden');
  }
}

// –§–∞–π–ª
const drop = document.getElementById('file-drop');
const input = document.getElementById('fileInput');
const fileName = document.getElementById('fileName');
const removeBtn = document.getElementById('removeFileBtn');
const label = document.getElementById('fileLabel');

drop.addEventListener('click', () => input.click());
input.addEventListener('change', e => {
  const file = e.target.files[0];
  if (file) {
    fileName.textContent = `üìé ${file.name}`;
    fileName.classList.remove('hidden');
    removeBtn.classList.remove('hidden');
    label.classList.add('hidden');
  }
});
removeBtn.addEventListener('click', () => {
  input.value = '';
  fileName.classList.add('hidden');
  removeBtn.classList.add('hidden');
  label.classList.remove('hidden');
});
</script>
{% endblock %}
