{% extends 'crm/base_crm.html' %}
{% load static %}

{% block content %}
<div class="container mx-auto px-6 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - –ø—Ä–æ—Ñ–∏–ª—å -->
        <div class="lg:col-span-1 space-y-6">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <div class="text-center">
                    <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center text-gray-600 font-bold text-2xl mx-auto mb-4">
                        {{ manager_user.first_name|first|default:manager_user.username|first }}
                    </div>
                    <h2 class="text-xl font-semibold text-gray-900 mb-1">{{ manager_user.get_full_name|default:manager_user.username }}</h2>
                    <p class="text-gray-500 mb-4">@{{ manager_user.username }}</p>
                    
                    <div class="flex justify-center gap-2 mb-4">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium {% if manager_profile.role == 'owner' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                            {{ manager_profile.get_role_display }}
                        </span>
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium {% if manager_user.is_active %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                            {% if manager_user.is_active %}–ê–∫—Ç–∏–≤–µ–Ω{% else %}–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω{% endif %}
                        </span>
                    </div>

                    <div class="space-y-2">
                        <a href="{% url 'crm_manager_edit' manager_profile.id %}" 
                           class="w-full bg-gray-800 hover:bg-gray-900 text-white py-2 px-4 rounded-lg font-medium transition-colors duration-200 flex items-center justify-center gap-2">
                            –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </a>
                        
                        {% if manager_profile.role != 'owner' %}
                        <form method="POST" action="{% url 'crm_manager_toggle_active' manager_profile.id %}">
                            {% csrf_token %}
                            <button type="submit" 
                                    class="w-full {% if manager_user.is_active %}bg-orange-500 hover:bg-orange-600{% else %}bg-green-500 hover:bg-green-600{% endif %} text-white py-2 px-4 rounded-lg font-medium transition-colors duration-200">
                                {% if manager_user.is_active %}–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å{% else %}–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å{% endif %}
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-sm font-medium text-gray-500">Email</label>
                        <div class="mt-1">
                            <a href="mailto:{{ manager_user.email }}" class="text-gray-900 hover:text-blue-600 transition-colors">
                                {{ manager_user.email }}
                            </a>
                        </div>
                    </div>
                    
                    {% if manager_profile.corporate_email %}
                    <div>
                        <label class="text-sm font-medium text-gray-500">–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π email</label>
                        <div class="mt-1">
                            <a href="mailto:{{ manager_profile.corporate_email }}" class="text-gray-900 hover:text-blue-600 transition-colors">
                                {{ manager_profile.corporate_email }}
                            </a>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if manager_profile.phone %}
                    <div>
                        <label class="text-sm font-medium text-gray-500">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <div class="mt-1">
                            <a href="tel:{{ manager_profile.phone }}" class="text-gray-900 hover:text-blue-600 transition-colors">
                                {{ manager_profile.phone }}
                            </a>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div>
                        <label class="text-sm font-medium text-gray-500">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</label>
                        <div class="mt-1 text-gray-900">
                            {{ manager_profile.created_at|date:"d.m.Y H:i" }}
                        </div>
                    </div>
                </div>
            </div>

            <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–º -->
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–º</h3>
                <div class="space-y-3">
                    <div>
                        <label class="text-sm font-medium text-gray-500">–°—Ç–∞—Ç—É—Å –ø–∞—Ä–æ–ª—è</label>
                        <div class="mt-1">
                            <div class="bg-gray-100 px-3 py-2 rounded text-sm text-gray-800">
                                –ü–∞—Ä–æ–ª—å —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <form method="POST" action="{% url 'crm_reset_manager_password' manager_profile.id %}">
                            {% csrf_token %}
                            <button type="submit" 
                                    class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-medium transition-colors duration-200">
                                –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å
                            </button>
                        </form>
                        <p class="text-xs text-gray-500 mt-2">
                            –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –º–µ–Ω–µ–¥–∂–µ—Ä—É
                        </p>
                    </div>
                    
                    <div>
                        <label class="text-sm font-medium text-gray-500">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</label>
                        <div class="mt-1 text-gray-900">
                            {% if manager_user.last_login %}
                                {{ manager_user.last_login|date:"d.m.Y H:i" }}
                            {% else %}
                                <span class="text-gray-400">–ù–∏–∫–æ–≥–¥–∞</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –∑–∞—è–≤–∫–∏ -->
        <div class="lg:col-span-2 space-y-6">
            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-6">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∑–∞—è–≤–∫–∞–º</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-blue-800 mb-1">{{ requests_stats.total_requests|default:0 }}</div>
                        <div class="text-blue-600 text-sm">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-blue-800 mb-1">{{ requests_stats.new_requests|default:0 }}</div>
                        <div class="text-blue-600 text-sm">–ù–æ–≤—ã–µ</div>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-yellow-800 mb-1">{{ requests_stats.in_progress_requests|default:0 }}</div>
                        <div class="text-yellow-600 text-sm">–í —Ä–∞–±–æ—Ç–µ</div>
                    </div>
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                        <div class="text-2xl font-bold text-green-800 mb-1">{{ requests_stats.completed_requests|default:0 }}</div>
                        <div class="text-green-600 text-sm">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</div>
                    </div>
                </div>
            </div>

            <!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞—è–≤–∫–∏ -->
            <div class="bg-white rounded-lg border border-gray-200 p-6">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞—è–≤–∫–∏</h3>
                    <a href="{% url 'crm_my_requests' %}" class="text-blue-600 hover:text-blue-700 text-sm font-medium">
                        –í—Å–µ –∑–∞—è–≤–∫–∏
                    </a>
                </div>

                {% if recent_requests %}
                <div class="space-y-3">
                    {% for request in recent_requests %}
                    <a href="{% url 'crm_request_detail' request.id %}" 
                       class="block p-4 border border-gray-200 rounded-lg hover:bg-gray-50 hover:border-gray-300 transition-colors duration-200 group">
                        <div class="flex items-center justify-between">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-3 mb-2">
                                    <span class="font-medium text-gray-900 group-hover:text-blue-600 transition-colors truncate">
                                        {{ request.client.company_name }}
                                    </span>
                                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium 
                                        {% if request.status == 'new' %}bg-blue-100 text-blue-800
                                        {% elif request.status == 'in_progress' %}bg-yellow-100 text-yellow-800
                                        {% elif request.status == 'completed' %}bg-green-100 text-green-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ request.get_status_display }}
                                    </span>
                                </div>
                                <div class="flex items-center gap-4 text-sm text-gray-500">
                                    <span>{{ request.object_type }}</span>
                                    <span>{{ request.created_at|date:"d.m.Y" }}</span>
                                </div>
                            </div>
                            <div class="text-gray-400 group-hover:text-blue-600 transition-colors">
                                ‚Üí
                            </div>
                        </div>
                    </a>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-gray-400 mx-auto mb-3">
                        üìã
                    </div>
                    <p class="text-gray-500">–ù–µ—Ç –∑–∞—è–≤–æ–∫</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}