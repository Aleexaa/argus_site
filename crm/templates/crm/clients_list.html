{% extends "crm/base_crm.html" %}
{% load static %}

{% block title %}–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã - CRM –ê—Ä–≥—É—Å{% endblock %}

{% block content %}
<div class="mb-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã</h1>
        
        <!-- –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ -->
        {% if is_owner %}
        <a href="{% url 'crm_create_client' %}" class="btn-gold px-6 py-3 rounded-lg font-medium flex items-center gap-2">
            <i data-lucide="plus" class="w-5 h-5"></i>
            –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
        </a>
        {% endif %}
    </div>

    <!-- üîç –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
    <div class="bg-white rounded-xl shadow-soft p-6 mb-6">
        <form method="GET" action="{% url 'crm_clients' %}" id="search-form">
            <div class="flex gap-4">
                <div class="flex-1">
                    <input type="text" 
                           name="search" 
                           value="{{ search_query }}"
                           placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∫–æ–º–ø–∞–Ω–∏–∏, –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–º—É –ª–∏—Ü—É, email –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É..."
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent">
                </div>
                <button type="submit" class="btn-gold px-6 py-3 rounded-lg font-medium flex items-center gap-2">
                    <i data-lucide="search" class="w-5 h-5"></i>
                    –ù–∞–π—Ç–∏
                </button>
                {% if search_query %}
                <a href="{% url 'crm_clients' %}" class="px-6 py-3 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 flex items-center gap-2">
                    <i data-lucide="x" class="w-5 h-5"></i>
                    –°–±—Ä–æ—Å–∏—Ç—å
                </a>
                {% endif %}
            </div>
        </form>
    </div>

    <!-- üìã –¢–∞–±–ª–∏—Ü–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ -->
    <div class="bg-white rounded-xl shadow-soft overflow-hidden">
        <div id="clients-container">
            {% include 'crm/partials/clients_table.html' %}
        </div>
    </div>

    <!-- üìÑ –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if is_paginated %}
    <div class="mt-6 flex justify-center">
        <nav class="flex items-center gap-2">
            {% if page_obj.has_previous %}
            <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}" 
               class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                –ü–µ—Ä–≤–∞—è
            </a>
            <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" 
               class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                –ù–∞–∑–∞–¥
            </a>
            {% endif %}

            <span class="px-4 py-2 text-gray-700">
                –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ paginator.num_pages }}
            </span>

            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}" 
               class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                –í–ø–µ—Ä–µ–¥
            </a>
            <a href="?page={{ paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}" 
               class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                –ü–æ—Å–ª–µ–¥–Ω—è—è
            </a>
            {% endif %}
        </nav>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
    function deleteClient(clientId) {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞? –í—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
            return;
        }

        fetch(`/crm/clients/${clientId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // –£–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                const row = document.querySelector(`[data-client-id="${clientId}"]`);
                if (row) {
                    row.remove();
                }
                showNotification('–ö–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', 'success');
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫, –µ—Å–ª–∏ —ç—Ç–æ –±—ã–ª–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø–∏—Å—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                refreshClientsList();
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞', 'error');
        });
    }

    // –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
    function editClient(clientId) {
        const row = document.querySelector(`[data-client-id="${clientId}"]`);
        if (!row) {
            showNotification('–û—à–∏–±–∫–∞: –∫–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
            return;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
        const companyName = row.querySelector('.client-company-name').textContent.trim();
        const contactPerson = row.querySelector('.client-contact-person').textContent.trim();
        const phone = row.querySelector('.client-phone').textContent.replace('üìû', '').replace('–ù–µ —É–∫–∞–∑–∞–Ω', '').trim();
        const email = row.querySelector('.client-email').textContent.replace('‚úâÔ∏è', '').replace('–ù–µ —É–∫–∞–∑–∞–Ω', '').trim();
        
        // –°–æ–∑–¥–∞–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const editForm = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" data-edit-modal>
                <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞</h3>
                        <button type="button" data-close-edit class="text-gray-500 hover:text-gray-700">
                            <i data-lucide="x" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <form id="edit-client-form" data-client-id="${clientId}">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ *
                                </label>
                                <input type="text" 
                                       name="company_name" 
                                       value="${companyName}"
                                       required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ
                                </label>
                                <input type="text" 
                                       name="contact_person" 
                                       value="${contactPerson}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    –¢–µ–ª–µ—Ñ–æ–Ω *
                                </label>
                                <input type="tel" 
                                       name="phone" 
                                       value="${phone}"
                                       required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Email
                                </label>
                                <input type="email" 
                                       name="email" 
                                       value="${email}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gold focus:border-transparent">
                            </div>
                        </div>
                        
                        <div class="flex gap-3 mt-6">
                            <button type="submit" 
                                    class="flex-1 bg-gold text-white py-2 rounded-lg font-medium hover:bg-yellow-600 transition-colors">
                                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                            </button>
                            <button type="button" 
                                    data-close-edit
                                    class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-lg font-medium hover:bg-gray-400 transition-colors">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –≤ DOM
        document.body.insertAdjacentHTML('beforeend', editForm);
        lucide.createIcons();
    }

    function closeEditForm() {
        const form = document.querySelector('[data-edit-modal]');
        if (form) {
            form.remove();
        }
    }

    function saveClientChanges(clientId) {
        const form = document.getElementById('edit-client-form');
        const formData = new FormData(form);
        
        fetch(`/crm/clients/${clientId}/update/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCSRFToken(),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü–µ
                updateClientRow(clientId, data.client);
                closeEditForm();
                showNotification('–î–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã', 'success');
            } else {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞', 'error');
        });
    }

    function updateClientRow(clientId, clientData) {
        const row = document.querySelector(`[data-client-id="${clientId}"]`);
        if (row && clientData) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å—Ç—Ä–æ–∫–µ —Ç–∞–±–ª–∏—Ü—ã
            row.querySelector('.client-company-name').textContent = clientData.company_name;
            row.querySelector('.client-contact-person').textContent = clientData.contact_person || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            
            const phoneElement = row.querySelector('.client-phone');
            phoneElement.innerHTML = clientData.phone ? 
                `<i data-lucide="phone" class="w-4 h-4 text-gray-400"></i> ${clientData.phone}` :
                '<span class="text-gray-500">–ù–µ —É–∫–∞–∑–∞–Ω</span>';
            
            const emailElement = row.querySelector('.client-email');
            emailElement.innerHTML = clientData.email ? 
                `<i data-lucide="mail" class="w-4 h-4 text-gray-400"></i> ${clientData.email}` :
                '<span class="text-gray-500">–ù–µ —É–∫–∞–∑–∞–Ω</span>';
            
            lucide.createIcons();
        }
    }

    function getCSRFToken() {
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
        return cookieValue || '';
    }

    function showNotification(message, type = 'info') {
        // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg text-white ${
            type === 'success' ? 'bg-green-500' : 
            type === 'error' ? 'bg-red-500' : 'bg-blue-500'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    function initEventHandlers() {
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–∞
        document.addEventListener('click', function(e) {
            const editBtn = e.target.closest('[data-edit-client]');
            if (editBtn) {
                const clientId = parseInt(editBtn.getAttribute('data-edit-client'));
                editClient(clientId);
                return;
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
            const deleteBtn = e.target.closest('[data-delete-client]');
            if (deleteBtn) {
                const clientId = parseInt(deleteBtn.getAttribute('data-delete-client'));
                deleteClient(clientId);
                return;
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ä–º—ã
            if (e.target.closest('[data-close-edit]')) {
                closeEditForm();
                return;
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        document.addEventListener('submit', function(e) {
            if (e.target.id === 'edit-client-form') {
                e.preventDefault();
                const clientId = parseInt(e.target.getAttribute('data-client-id'));
                saveClientChanges(clientId);
            }
        });
    }

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤
    function refreshClientsList() {
        const searchForm = document.getElementById('search-form');
        const formData = new FormData(searchForm);
        const searchParams = new URLSearchParams(formData);
        
        fetch(`{% url 'crm_clients' %}?${searchParams.toString()}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        })
        .then(response => response.text())
        .then(html => {
            document.getElementById('clients-container').innerHTML = html;
            lucide.createIcons();
        })
        .catch(error => console.error('Error refreshing clients:', error));
    }

    // –ü–æ–∏—Å–∫ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
    let searchTimeout;
    const searchInput = document.querySelector('input[name="search"]');
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                refreshClientsList();
            }, 500);
        });
    }

    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
    setInterval(refreshClientsList, 30000);

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        initEventHandlers();
        lucide.createIcons();
    });
</script>
{% endblock %}