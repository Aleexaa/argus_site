{% extends "crm/base_crm.html" %}
{% load static %}

{% block title %}–ú–æ–∏ –∑–∞—è–≤–∫–∏ - CRM –ê—Ä–≥—É—Å{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- üîπ –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="mb-8">
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-6 mb-6">
            <div class="flex-1">
                <div class="flex items-center gap-4 mb-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl flex items-center justify-center shadow-lg">
                        <i data-lucide="clipboard-list" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl lg:text-3xl font-bold text-gray-900">
                            {% if is_owner %}
                            –í—Å–µ –∑–∞—è–≤–∫–∏
                            {% else %}
                            –ú–æ–∏ –∑–∞—è–≤–∫–∏
                            {% endif %}
                        </h1>
                        <p class="text-gray-600 mt-1">
                            {% if is_owner %}
                            –ü–æ–ª–Ω—ã–π –æ–±–∑–æ—Ä –≤—Å–µ—Ö –∑–∞—è–≤–æ–∫ —Å–∏—Å—Ç–µ–º—ã
                            {% else %}
                            –ó–∞—è–≤–∫–∏, –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –≤–∞–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
                            {% endif %}
                        </p>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                    
                    <!-- –ë–µ–π–¥–∂ —Ä–æ–ª–∏ -->
                    <div class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-4 py-3 rounded-2xl shadow-lg">
                        <div class="flex items-center gap-2">
                            <i data-lucide="{% if is_owner %}shield{% else %}user{% endif %}" class="w-4 h-4"></i>
                            <span class="font-semibold text-sm">
                                {% if is_owner %}–í–ª–∞–¥–µ–ª–µ—Ü{% else %}–ú–µ–Ω–µ–¥–∂–µ—Ä{% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                <div class="flex items-center gap-3">
                    <a href="{% url 'crm_create_request' %}" 
                       class="group flex items-center gap-2 px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-2xl hover:from-green-600 hover:to-emerald-600 transition-all duration-200 shadow-lg shadow-green-500/25 hover:shadow-xl hover:shadow-green-500/30 font-medium">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞
                    </a>
                </div>
            </div>
        </div>
        
        <!-- üîπ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞ -->
        {% if is_owner %}
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-2xl p-6 mb-6">
            <div class="flex items-start gap-4">
                <div class="w-12 h-12 bg-blue-100 rounded-2xl flex items-center justify-center flex-shrink-0">
                    <i data-lucide="shield" class="w-6 h-6 text-blue-600"></i>
                </div>
                <div class="flex-1">
                    <h3 class="font-semibold text-blue-900 mb-2 text-lg">–†–µ–∂–∏–º –≤–ª–∞–¥–µ–ª—å—Ü–∞</h3>
                    <p class="text-blue-800 leading-relaxed">
                        –í—ã –≤–∏–¥–∏—Ç–µ –≤—Å–µ –∑–∞—è–≤–∫–∏ —Å–∏—Å—Ç–µ–º—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∞–º–∏.
                    </p>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- üîπ –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-6 mb-8">
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- –ü–æ–∏—Å–∫ -->
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">–ü–æ–∏—Å–∫ –∑–∞—è–≤–æ–∫</label>
                <div class="relative">
                    <i data-lucide="search" class="w-5 h-5 text-gray-400 absolute left-4 top-1/2 transform -translate-y-1/2"></i>
                    <input type="text" id="search-input" placeholder="–ö–æ–º–ø–∞–Ω–∏—è, –∞–¥—Ä–µ—Å, –∫–æ–Ω—Ç–∞–∫—Ç..." 
                           class="w-full pl-12 pr-4 py-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-all duration-200">
                </div>
            </div>
            
            <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É -->
            <div class="w-full lg:w-64">
                <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ç–∞—Ç—É—Å</label>
                <div class="relative">
                    <i data-lucide="filter" class="w-5 h-5 text-gray-400 absolute left-4 top-1/2 transform -translate-y-1/2"></i>
                    <select id="status-filter" class="w-full pl-12 pr-4 py-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-all duration-200 appearance-none">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="new">üÜï –ù–æ–≤—ã–µ</option>
                        <option value="in_progress">üîÑ –í —Ä–∞–±–æ—Ç–µ</option>
                        <option value="kp_ready">üìÑ –ö–ü –≥–æ—Ç–æ–≤–æ</option>
                        <option value="closed">‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω—ã</option>
                    </select>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none"></i>
                </div>
            </div>
            
            <!-- –§–∏–ª—å—Ç—Ä –ø–æ —Ñ–∞–π–ª—É -->
            <div class="w-full lg:w-56">
                <label class="block text-sm font-medium text-gray-700 mb-2">–§–∞–π–ª—ã</label>
                <div class="relative">
                    <i data-lucide="paperclip" class="w-5 h-5 text-gray-400 absolute left-4 top-1/2 transform -translate-y-1/2"></i>
                    <select id="file-filter" class="w-full pl-12 pr-4 py-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-all duration-200 appearance-none">
                        <option value="">–í—Å–µ –∑–∞—è–≤–∫–∏</option>
                        <option value="with_file">üìé –° —Ñ–∞–π–ª–æ–º</option>
                        <option value="without_file">üìù –ë–µ–∑ —Ñ–∞–π–ª–∞</option>
                    </select>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none"></i>
                </div>
            </div>
            
            <!-- –§–∏–ª—å—Ç—Ä –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä—É -->
            {% if is_owner %}
            <div class="w-full lg:w-64">
                <label class="block text-sm font-medium text-gray-700 mb-2">–ú–µ–Ω–µ–¥–∂–µ—Ä</label>
                <div class="relative">
                    <i data-lucide="users" class="w-5 h-5 text-gray-400 absolute left-4 top-1/2 transform -translate-y-1/2"></i>
                    <select id="manager-filter" class="w-full pl-12 pr-4 py-3 bg-gray-50 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:bg-white transition-all duration-200 appearance-none">
                        <option value="">–í—Å–µ –º–µ–Ω–µ–¥–∂–µ—Ä—ã</option>
                        <option value="unassigned">‚è≥ –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã</option>
                        {% for manager in managers %}
                        <option value="{{ manager.id }}">üë§ {{ manager.user.get_full_name|default:manager.user.username }}</option>
                        {% endfor %}
                    </select>
                    <i data-lucide="chevron-down" class="w-4 h-4 text-gray-400 absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none"></i>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    
<!-- üîπ –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ -->
<div id="requests-container">
    {% if requests %}
        <div id="requests-list" class="grid gap-4">
            {% for req in requests %}
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞—è–≤–∫–∏ -->
            <div class="request-card group bg-white rounded-2xl shadow-sm border border-gray-200 hover:shadow-xl hover:border-blue-300 transition-all duration-300 relative overflow-hidden"
                 data-request-id="{{ req.id }}" 
                 data-status="{{ req.status }}"
                 data-has-file="{% if req.attached_file %}true{% else %}false{% endif %}"
                 data-company="{{ req.client.company_name|lower }}"
                 data-address="{{ req.object_address|lower }}"
                 data-contact="{{ req.client.contact_person|lower }}"
                 {% if is_owner %}data-manager="{% if req.responsible_manager %}{{ req.responsible_manager.id }}{% else %}unassigned{% endif %}"{% endif %}>
                
                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ -->
                <div class="absolute top-0 left-0 w-2 h-full 
                    {% if req.status == 'new' %}bg-blue-500
                    {% elif req.status == 'in_progress' %}bg-amber-500
                    {% elif req.status == 'kp_ready' %}bg-purple-500
                    {% else %}bg-green-500{% endif %}">
                </div>

                <div class="p-6">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å—Ç–∞—Ç—É—Å—ã -->
                    <div class="flex flex-col lg:flex-row lg:items-start justify-between gap-4 mb-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-3 mb-3">
                                <h3 class="text-xl font-bold text-gray-900 truncate">{{ req.client.company_name }}</h3>
                            </div>
                            
                            <!-- –ë–µ–π–¥–∂–∏ -->
                            <div class="flex flex-wrap gap-2">
                                <span class="status-badge status-{{ req.status }} flex items-center gap-1">
                                    {% if req.status == 'new' %}üÜï
                                    {% elif req.status == 'in_progress' %}üîÑ
                                    {% elif req.status == 'kp_ready' %}üìÑ
                                    {% else %}‚úÖ{% endif %}
                                    {{ req.get_status_display }}
                                </span>
                                
                                {% if req.attached_file %}
                                <span class="bg-green-100 text-green-800 text-xs px-3 py-1.5 rounded-full border border-green-200 font-medium flex items-center gap-1">
                                    <i data-lucide="paperclip" class="w-3 h-3"></i>
                                    –§–∞–π–ª
                                </span>
                                {% endif %}
                                
                                {% if is_owner and not req.responsible_manager %}
                                <span class="bg-orange-100 text-orange-800 text-xs px-3 py-1.5 rounded-full border border-orange-200 font-medium flex items-center gap-1">
                                    <i data-lucide="user-x" class="w-3 h-3"></i>
                                    –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ
                                </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
                        <div class="flex items-center gap-2">
                            <a href="{% url 'crm_request_detail' req.id %}" 
                               class="group/view flex items-center gap-2 px-4 py-2.5 bg-blue-500 text-white rounded-xl hover:bg-blue-600 transition-all duration-200 shadow-sm hover:shadow-md font-medium">
                                <i data-lucide="eye" class="w-4 h-4"></i>
                                –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                            </a>
                            
                            {% if is_owner and not req.responsible_manager %}
                            <a href="{% url 'crm_assign_manager' req.id %}" 
                               class="group/assign flex items-center gap-2 px-4 py-2.5 bg-orange-500 text-white rounded-xl hover:bg-orange-600 transition-all duration-200 shadow-sm hover:shadow-md font-medium">
                                <i data-lucide="user-plus" class="w-4 h-4"></i>
                                –ù–∞–∑–Ω–∞—á–∏—Ç—å
                            </a>
                            {% endif %}
                            
                            <button onclick="deleteRequest('{{ req.id }}')" 
                                    class="group/delete flex items-center gap-2 px-4 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-xl hover:bg-red-50 hover:border-red-200 hover:text-red-600 transition-all duration-200 shadow-sm hover:shadow-md font-medium">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                                –£–¥–∞–ª–∏—Ç—å
                            </button>
                        </div>
                    </div>

                    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6 mb-4">
                        <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                        <div class="space-y-3">
                            <div class="flex items-center gap-3 text-gray-700">
                                <div class="w-8 h-8 bg-blue-50 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="user" class="w-4 h-4 text-blue-600"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-sm">{{ req.client.contact_person }}</div>
                                    <div class="text-xs text-gray-500">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ</div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 text-gray-700">
                                <div class="w-8 h-8 bg-green-50 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="phone" class="w-4 h-4 text-green-600"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-sm">{{ req.client.phone }}</div>
                                    <div class="text-xs text-gray-500">–¢–µ–ª–µ—Ñ–æ–Ω</div>
                                </div>
                            </div>
                        </div>

                        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—ä–µ–∫—Ç–µ -->
                        <div class="space-y-3">
                            <div class="flex items-center gap-3 text-gray-700">
                                <div class="w-8 h-8 bg-purple-50 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="building" class="w-4 h-4 text-purple-600"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-sm">
                                        {% if req.object_type == 'office' %}
                                            üè¢ –û—Ñ–∏—Å
                                        {% elif req.object_type == 'apartment' %}
                                            üè† –ö–≤–∞—Ä—Ç–∏—Ä–∞
                                        {% elif req.object_type == 'house' %}
                                            üè° –ß–∞—Å—Ç–Ω—ã–π –¥–æ–º
                                        {% elif req.object_type == 'commercial' %}
                                            üè™ –ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø–æ–º–µ—â–µ–Ω–∏–µ
                                        {% elif req.object_type == 'industrial' %}
                                            üè≠ –ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç
                                        {% elif req.object_type == 'other' %}
                                            üìç –î—Ä—É–≥–æ–π —Ç–∏–ø
                                        {% else %}
                                            {{ req.object_type }}
                                        {% endif %}
                                    </div>
                                    <div class="text-xs text-gray-500">–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞</div>
                                </div>
                            </div>
                            {% if req.area %}
                            <div class="flex items-center gap-3 text-gray-700">
                                <div class="w-8 h-8 bg-amber-50 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="maximize" class="w-4 h-4 text-amber-600"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-sm">{{ req.area }} –º¬≤</div>
                                    <div class="text-xs text-gray-500">–ü–ª–æ—â–∞–¥—å</div>
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- –ê–¥—Ä–µ—Å -->
                        {% if req.object_address %}
                        <div class="space-y-3">
                            <div class="flex items-start gap-3 text-gray-700">
                                <div class="w-8 h-8 bg-red-50 rounded-lg flex items-center justify-center flex-shrink-0 mt-1">
                                    <i data-lucide="map-pin" class="w-4 h-4 text-red-600"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-sm line-clamp-2">{{ req.object_address }}</div>
                                    <div class="text-xs text-gray-500">–ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞</div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <!-- –ú–µ–Ω–µ–¥–∂–µ—Ä (–¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞) -->
                        {% if is_owner %}
                        <div class="space-y-3">
                            <div class="flex items-center gap-3 text-gray-700">
                                <div class="w-8 h-8 bg-indigo-50 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i data-lucide="users" class="w-4 h-4 text-indigo-600"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-sm {% if not req.responsible_manager %}text-orange-600{% endif %}">
                                        {% if req.responsible_manager %}
                                            {{ req.responsible_manager.user.get_full_name|default:req.responsible_manager.user.username }}
                                        {% else %}
                                            –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω
                                        {% endif %}
                                    </div>
                                    <div class="text-xs text-gray-500">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
                    {% if req.description %}
                    <div class="bg-gray-50 rounded-xl p-4 mb-4 border border-gray-200">
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                <i data-lucide="file-text" class="w-4 h-4 text-gray-600"></i>
                            </div>
                            <p class="text-gray-700 text-sm leading-relaxed flex-1">{{ req.description|truncatewords:30 }}</p>
                        </div>
                    </div>
                    {% endif %}

                    <!-- –§–∞–π–ª –∏ –º–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 pt-4 border-t border-gray-200">
                        <div class="flex items-center gap-4 text-sm text-gray-500 flex-wrap">
                            <div class="flex items-center gap-2">
                                <i data-lucide="calendar" class="w-4 h-4"></i>
                                <span>–°–æ–∑–¥–∞–Ω–æ: {{ req.created_at|date:"d.m.Y H:i" }}</span>
                            </div>
                            {% if req.updated_at != req.created_at %}
                            <div class="flex items-center gap-2">
                                <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                                <span>–û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ req.updated_at|date:"d.m.Y H:i" }}</span>
                            </div>
                            {% endif %}
                        </div>

                        <div class="flex items-center gap-3">
                            {% if req.attached_file %}
                            <a href="{% url 'crm_download_file' req.id %}" 
                               class="group/file flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-all duration-200 font-medium">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
                                <span class="text-xs bg-gray-300 text-gray-700 px-2 py-1 rounded-lg">
                                    {{ req.attached_file.size|filesizeformat }}
                                </span>
                            </a>
                            {% endif %}
                            
                            <span class="text-xs text-gray-400 font-mono bg-gray-100 px-2 py-1 rounded">
                                ID: {{ req.id }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- üîπ –ü–ê–ì–ò–ù–ê–¶–ò–Ø -->
        {% if is_paginated %}
        <div class="mt-8 flex justify-center">
            <div class="flex items-center gap-3 bg-white rounded-2xl border border-gray-200 px-6 py-4 shadow-sm">
                {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}" class="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-all duration-200 font-medium">
                    <i data-lucide="chevron-left" class="w-4 h-4"></i>
                    –ù–∞–∑–∞–¥
                </a>
                {% endif %}
                
                <div class="flex gap-1">
                    {% for num in page_obj.paginator.page_range %}
                        {% if page_obj.number == num %}
                        <span class="px-4 py-2 bg-blue-500 text-white rounded-xl font-medium shadow-lg">{{ num }}</span>
                        {% else %}
                        <a href="?page={{ num }}" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all duration-200">
                            {{ num }}
                        </a>
                        {% endif %}
                    {% endfor %}
                </div>
                
                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}" class="flex items-center gap-2 px-4 py-2 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-all duration-200 font-medium">
                    –í–ø–µ—Ä–µ–¥
                    <i data-lucide="chevron-right" class="w-4 h-4"></i>
                </a>
                {% endif %}
                
                <div class="text-sm text-gray-500 ml-4">
                    –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ page_obj.number }} –∏–∑ {{ paginator.num_pages }}
                </div>
            </div>
        </div>
        {% endif %}
        
    {% else %}
        <!-- üîπ –°–æ—Å—Ç–æ—è–Ω–∏–µ "–Ω–µ—Ç –∑–∞—è–≤–æ–∫" -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-16 text-center">
            <div class="max-w-md mx-auto">
                <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-gray-100 to-gray-200 rounded-3xl flex items-center justify-center">
                    <i data-lucide="inbox" class="w-12 h-12 text-gray-400"></i>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-3">
                    {% if is_owner %}
                    –ó–∞—è–≤–æ–∫ –Ω–µ—Ç –≤ —Å–∏—Å—Ç–µ–º–µ
                    {% else %}
                    –ó–∞—è–≤–æ–∫ –Ω–µ—Ç
                    {% endif %}
                </h3>
                <p class="text-gray-600 mb-8 text-lg">
                    {% if is_owner %}
                    –í —Å–∏—Å—Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫. –ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
                    {% else %}
                    –ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —É –≤–∞—Å –Ω–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫.
                    {% endif %}
                </p>
                
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                   <a href="{% url 'crm_create_request' %}" class="inline-flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-2xl hover:from-blue-600 hover:to-blue-700 transition-all duration-200 shadow-lg hover:shadow-xl font-medium">
                        <i data-lucide="plus" class="w-5 h-5"></i>
                        –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
                    </a>
                    
                    {% if request.user.managerprofile.role == 'manager' %}
                    <a href="{% url 'crm_add_project' %}" class="inline-flex items-center gap-3 px-8 py-4 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-2xl hover:from-green-600 hover:to-emerald-600 transition-all duration-200 shadow-lg hover:shadow-xl font-medium">
                        <i data-lucide="folder-plus" class="w-5 h-5"></i>
                        –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}
</div>
</div>

<!-- üîπ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div id="delete-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 hidden animate-fade-in">
    <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 shadow-2xl border border-gray-200 transform animate-scale-in">
        <div class="flex items-center gap-4 mb-4">
            <div class="w-12 h-12 bg-red-50 rounded-2xl flex items-center justify-center">
                <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-gray-900">–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏</h3>
                <p class="text-sm text-gray-500 mt-1">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å</p>
            </div>
        </div>
        
        <p class="text-gray-600 mb-6" id="delete-message">
            –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞—è–≤–∫—É?
        </p>
        
        <div class="flex gap-3">
            <button id="cancel-delete" class="flex-1 px-4 py-2.5 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-all duration-200 font-medium">
                –û—Ç–º–µ–Ω–∞
            </button>
            <button id="confirm-delete" class="flex-1 px-4 py-2.5 bg-gradient-to-r from-red-500 to-rose-500 text-white rounded-xl hover:from-red-600 hover:to-rose-600 transition-all duration-200 font-medium flex items-center justify-center gap-2 shadow-lg shadow-red-500/25">
                <i data-lucide="trash-2" class="w-4 h-4"></i>
                –£–¥–∞–ª–∏—Ç—å
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ============================================================
// üóëÔ∏è –°–ò–°–¢–ï–ú–ê –£–î–ê–õ–ï–ù–ò–Ø –ó–ê–Ø–í–û–ö
// ============================================================
let currentRequestId = null;

function deleteRequest(requestId) {
    console.log('üóëÔ∏è –ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏:', requestId);
    currentRequestId = requestId;
    
    const modal = document.getElementById('delete-modal');
    const message = document.getElementById('delete-message');
    
    const requestElement = document.querySelector(`[data-request-id="${requestId}"]`);
    const companyName = requestElement ? requestElement.querySelector('h3').textContent : '—ç—Ç—É –∑–∞—è–≤–∫—É';
    
    message.textContent = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É "${companyName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`;
    modal.classList.remove('hidden');
}

function confirmDelete() {
    if (!currentRequestId) {
        console.error('‚ùå ID –∑–∞—è–≤–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
        return;
    }
    
    console.log('‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏:', currentRequestId);
    
    const confirmBtn = document.getElementById('confirm-delete');
    const originalText = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> –£–¥–∞–ª–µ–Ω–∏–µ...';
    confirmBtn.disabled = true;
    
    const url = `/crm/request/${currentRequestId}/delete/`;
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCSRFToken(),
        },
        body: new FormData()
    })
    .then(response => {
        if (response.status === 403) {
            throw new Error('CSRF —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω');
        }
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            const element = document.querySelector(`[data-request-id="${currentRequestId}"]`);
            if (element) {
                element.style.transform = 'translateX(100%)';
                element.style.opacity = '0';
                setTimeout(() => {
                    element.remove();
                    updateRequestCount();
                    checkEmptyList();
                }, 300);
            }
            showMessage(data.message, 'success');
        } else {
            throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
        }
    })
    .catch(error => {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', error);
        showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏: ' + error.message, 'error');
    })
    .finally(() => {
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
        lucide.createIcons();
        closeDeleteModal();
    });
}

function closeDeleteModal() {
    const modal = document.getElementById('delete-modal');
    modal.classList.add('hidden');
    currentRequestId = null;
}

function getCSRFToken() {
    let csrfToken = '';
    const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
    if (csrfInput) csrfToken = csrfInput.value;
    
    if (!csrfToken) {
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];
        if (cookieValue) csrfToken = decodeURIComponent(cookieValue);
    }
    
    return csrfToken;
}

function updateRequestCount() {
    const requestItems = document.querySelectorAll('.request-item');
    const totalCount = document.getElementById('total-count');
    if (totalCount) {
        totalCount.textContent = requestItems.length;
    }
}

function checkEmptyList() {
    const requestItems = document.querySelectorAll('.request-item');
    const requestsList = document.getElementById('requests-list');
    
    if (requestItems.length === 0 && requestsList) {
        requestsList.innerHTML = `
            <div class="bg-white rounded-2xl shadow-lg border border-gray-200 p-16 text-center">
                <div class="max-w-md mx-auto">
                    <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-gray-100 to-gray-200 rounded-3xl flex items-center justify-center">
                        <i data-lucide="inbox" class="w-12 h-12 text-gray-400"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-3">–í—Å–µ –∑–∞—è–≤–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã</h3>
                    <p class="text-gray-600 mb-8 text-lg">–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
                </div>
            </div>
        `;
        lucide.createIcons();
    }
}

function showMessage(message, type) {
    const existingMessages = document.querySelectorAll('.temp-message');
    existingMessages.forEach(msg => msg.remove());
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `temp-message fixed top-4 right-4 z-50 px-6 py-4 rounded-2xl shadow-xl border backdrop-blur-sm transform animate-scale-in ${
        type === 'success' 
            ? 'bg-gradient-to-r from-green-50 to-emerald-50 border-green-200 text-green-700' 
            : 'bg-gradient-to-r from-red-50 to-rose-50 border-red-200 text-red-700'
    }`;
    messageDiv.innerHTML = `
        <div class="flex items-center gap-3">
            <i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-5 h-5"></i>
            <span class="font-medium">${message}</span>
        </div>
    `;
    document.body.appendChild(messageDiv);
    
    lucide.createIcons();
    
    setTimeout(() => {
        if (messageDiv.parentElement) {
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                if (messageDiv.parentElement) {
                    document.body.removeChild(messageDiv);
                }
            }, 300);
        }
    }, 4000);
}

// ============================================================
// üîç –°–ò–°–¢–ï–ú–ê –§–ò–õ–¨–¢–†–ê–¶–ò–ò
// ============================================================
function setupFilters() {
    const searchInput = document.getElementById('search-input');
    const statusFilter = document.getElementById('status-filter');
    const fileFilter = document.getElementById('file-filter');
    const managerFilter = document.getElementById('manager-filter');
    
    function filterRequests() {
        const searchTerm = searchInput.value.toLowerCase();
        const statusValue = statusFilter.value;
        const fileValue = fileFilter.value;
        const managerValue = managerFilter ? managerFilter.value : '';
        
        let visibleCount = 0;
        
        document.querySelectorAll('.request-card').forEach(item => {
            const company = item.getAttribute('data-company');
            const address = item.getAttribute('data-address');
            const contact = item.getAttribute('data-contact');
            const status = item.getAttribute('data-status');
            const hasFile = item.getAttribute('data-has-file');
            const manager = item.getAttribute('data-manager');
            
            const matchesSearch = !searchTerm || 
                company.includes(searchTerm) || 
                address.includes(searchTerm) || 
                contact.includes(searchTerm);
            
            const matchesStatus = !statusValue || status === statusValue;
            
            let matchesFile = true;
            if (fileValue === 'with_file') {
                matchesFile = hasFile === 'true';
            } else if (fileValue === 'without_file') {
                matchesFile = hasFile === 'false';
            }
            
            let matchesManager = true;
            if (managerValue && manager) {
                if (managerValue === 'unassigned') {
                    matchesManager = manager === 'unassigned';
                } else {
                    matchesManager = manager === managerValue;
                }
            }
            
            if (matchesSearch && matchesStatus && matchesFile && matchesManager) {
                item.style.display = 'block';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        const totalCount = document.getElementById('total-count');
        if (totalCount) {
            totalCount.textContent = visibleCount;
        }
        
        const requestsList = document.getElementById('requests-list');
        const noResults = document.getElementById('no-results-message');
        
        if (visibleCount === 0 && requestsList) {
            if (!noResults) {
                const message = document.createElement('div');
                message.id = 'no-results-message';
                message.className = 'bg-white rounded-2xl shadow-lg border border-gray-200 p-16 text-center';
                message.innerHTML = `
                    <div class="max-w-md mx-auto">
                        <div class="w-24 h-24 mx-auto mb-6 bg-gradient-to-br from-gray-100 to-gray-200 rounded-3xl flex items-center justify-center">
                            <i data-lucide="search" class="w-12 h-12 text-gray-400"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-900 mb-3">–ó–∞—è–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                        <p class="text-gray-600 text-lg">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞ –∏–ª–∏ —Ñ–∏–ª—å—Ç—Ä—ã</p>
                    </div>
                `;
                requestsList.parentNode.appendChild(message);
                lucide.createIcons();
            }
        } else if (noResults) {
            noResults.remove();
        }
    }
    
    searchInput.addEventListener('input', filterRequests);
    statusFilter.addEventListener('change', filterRequests);
    fileFilter.addEventListener('change', filterRequests);
    if (managerFilter) {
        managerFilter.addEventListener('change', filterRequests);
    }
    
    filterRequests();
}

// ============================================================
// üöÄ –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
// ============================================================
document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
    
    document.getElementById('cancel-delete').addEventListener('click', closeDeleteModal);
    document.getElementById('confirm-delete').addEventListener('click', confirmDelete);
    
    setupFilters();
    
    console.log('‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–ú–æ–∏ –∑–∞—è–≤–∫–∏" –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
});

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
async function markAllAsViewed() {
    // –õ–æ–≥–∏–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –≤—Å–µ—Ö –∑–∞—è–≤–æ–∫ –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö
    console.log('–û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ');
}
</script>

<style>
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes scaleIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
}

@keyframes slideIn {
    from { opacity: 0; transform: translateX(100%); }
    to { opacity: 1; transform: translateX(0); }
}

.animate-fade-in { animation: fadeIn 0.3s ease-out; }
.animate-scale-in { animation: scaleIn 0.2s ease-out; }
.animate-slide-in { animation: slideIn 0.5s ease-out; }

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å-–±–µ–π–¥–∂–µ–π */
.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
    border: 1px solid;
}

.status-new { background-color: #dbeafe; color: #1e40af; border-color: #93c5fd; }
.status-in_progress { background-color: #fef3c7; color: #92400e; border-color: #fcd34d; }
.status-kp_ready { background-color: #f3e8ff; color: #6b21a8; border-color: #d8b4fe; }
.status-closed { background-color: #dcfce7; color: #166534; border-color: #86efac; }

.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* –ü–ª–∞–≤–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã */
.request-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.request-card:hover {
    transform: translateY(-2px);
}

/* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª–±–∞—Ä */
::-webkit-scrollbar {
    width: 6px;
}

::-webkit-scrollbar-track {
    background: #f1f5f9;
}

::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}
</style>
{% endblock %}