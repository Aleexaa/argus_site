{% extends 'crm/base_crm.html' %}
{% load static %}

{% block title %}–ó–∞—è–≤–∫–∏ | CRM –ê—Ä–≥—É—Å{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
  <h2 class="text-2xl font-semibold text-dark flex items-center gap-3">
    üìã –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫
    <span id="loading-spinner" class="hidden text-sm text-blue-500">
      <svg class="animate-spin h-5 w-5 mr-2 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      –ó–∞–≥—Ä—É–∑–∫–∞...
    </span>
  </h2>
  <div class="flex items-center gap-4">
    <span id="new-alert"
          class="hidden text-sm bg-green-500/20 text-green-600 px-3 py-2 rounded-lg border border-green-500/30 shadow-sm">
      üîî <span id="new-count">0</span> –Ω–µ–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫!
    </span>
    <button onclick="markAllAsViewed()" 
            class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
      <i data-lucide="eye" class="w-4 h-4"></i>
      –û—Ç–º–µ—Ç–∏—Ç—å –≤—Å–µ –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ
    </button>
  </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã –ø–æ —Å—Ç–∞—Ç—É—Å—É -->
<div class="mb-6 flex gap-2 flex-wrap">
    <a href="{% url 'crm_dashboard' %}" class="px-4 py-2 text-sm rounded-lg {% if not status_filter %}bg-gold text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} transition-colors">
        –í—Å–µ –∑–∞—è–≤–∫–∏
    </a>
    <a href="?status=new" class="px-4 py-2 text-sm rounded-lg {% if status_filter == 'new' %}bg-blue-500 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} transition-colors">
        –ù–æ–≤—ã–µ
    </a>
    <a href="?status=in_progress" class="px-4 py-2 text-sm rounded-lg {% if status_filter == 'in_progress' %}bg-yellow-500 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} transition-colors">
        –í —Ä–∞–±–æ—Ç–µ
    </a>
    <a href="?status=kp_ready" class="px-4 py-2 text-sm rounded-lg {% if status_filter == 'kp_ready' %}bg-purple-500 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} transition-colors">
        –ö–ü –≥–æ—Ç–æ–≤–æ
    </a>
    <a href="?status=closed" class="px-4 py-2 text-sm rounded-lg {% if status_filter == 'closed' %}bg-green-500 text-white{% else %}bg-gray-200 text-gray-700 hover:bg-gray-300{% endif %} transition-colors">
        –ó–∞–≤–µ—Ä—à–µ–Ω—ã
    </a>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ –∑–∞—è–≤–æ–∫ -->
<div id="requests-list" class="space-y-4">
    {% for req in requests %}
    <div class="request-item bg-white rounded-xl shadow-sm p-6 border-l-4 border-gold hover:shadow-md transition-all duration-300 relative"
         data-request-id="{{ req.id }}" data-status="{{ req.status }}">
        <div class="flex justify-between items-start">
            <div class="flex-1">
                <div class="flex items-center gap-3 mb-2">
                    <h3 class="font-semibold text-lg text-gray-800">{{ req.client.company_name }}</h3>
                    {% if req.status == 'new' %}
                    <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full animate-pulse">
                        –ù–û–í–ê–Ø
                    </span>
                    {% endif %}
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                    <div>
                        <p class="text-gray-600 text-sm"><strong>–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞:</strong> {{ req.get_object_type_display_ru }}</p>
                        {% if req.area %}
                        <p class="text-gray-600 text-sm"><strong>–ü–ª–æ—â–∞–¥—å:</strong> {{ req.area }} –º¬≤</p>
                        {% endif %}
                    </div>
                    <div>
                        {% if req.responsible_manager %}
                        <p class="text-gray-600 text-sm"><strong>–ú–µ–Ω–µ–¥–∂–µ—Ä:</strong> {{ req.responsible_manager.user.get_full_name|default:req.responsible_manager.user.username }}</p>
                        {% else %}
                        <p class="text-gray-600 text-sm"><strong>–ú–µ–Ω–µ–¥–∂–µ—Ä:</strong> <span class="text-orange-500">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span></p>
                        {% endif %}
                    </div>
                </div>
                
                {% if req.description %}
                <div class="bg-gray-50 rounded-lg p-3 mb-3">
                    <p class="text-sm text-gray-700 italic">üìù {{ req.description|truncatechars:200 }}</p>
                </div>
                {% endif %}

                {% if req.object_address %}
                <p class="text-sm text-gray-600 mb-2">üìç <strong>–ê–¥—Ä–µ—Å:</strong> {{ req.object_address }}</p>
                {% endif %}

                {% if req.attached_file %}
                <div class="mt-4">
                    <a href="{% url 'crm_download_file' req.id %}" 
                       class="download-btn inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium shadow-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
                        <span class="text-xs bg-green-700 px-2 py-1 rounded">
                            {{ req.attached_file.size|filesizeformat }}
                        </span>
                    </a>
                    <p class="text-xs text-gray-500 mt-1">
                        {{ req.attached_file.name|cut:"requests/"|cut:"kp_files/" }}
                    </p>
                </div>
                {% endif %}
            </div>
            
            <div class="flex flex-col items-end gap-3 ml-4">
                <span class="text-sm px-3 py-1 rounded-full font-medium 
                    {% if req.status == 'new' %}bg-blue-100 text-blue-800 border border-blue-200
                    {% elif req.status == 'in_progress' %}bg-yellow-100 text-yellow-800 border border-yellow-200
                    {% elif req.status == 'kp_ready' %}bg-purple-100 text-purple-800 border border-purple-200
                    {% elif req.status == 'closed' %}bg-green-100 text-green-800 border border-green-200
                    {% else %}bg-gray-100 text-gray-800 border border-gray-200{% endif %}">
                    {{ req.get_status_display }}
                </span>
                
                <a href="{% url 'crm_request_detail' req.id %}" 
                   class="view-request-btn bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                    <span>–ü–æ–¥—Ä–æ–±–Ω–µ–µ</span>
                    <span>‚Üí</span>
                </a>
            </div>
        </div>

        <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center text-xs text-gray-500">
            <div class="flex items-center gap-4">
                <span>üìÖ –°–æ–∑–¥–∞–Ω–æ: {{ req.created_at|date:"d.m.Y H:i" }}</span>
                {% if req.updated_at != req.created_at %}
                <span>üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–æ: {{ req.updated_at|date:"d.m.Y H:i" }}</span>
                {% endif %}
            </div>
            
            {% if is_owner and not req.responsible_manager %}
            <span class="text-orange-500 font-medium">‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞</span>
            {% endif %}
        </div>
    </div>
    {% empty %}
    <div class="bg-white rounded-xl shadow-sm p-12 text-center">
        <div class="text-6xl mb-4">üì≠</div>
        <p class="text-gray-500 text-xl font-medium mb-2">–ù–µ—Ç –∑–∞—è–≤–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
        <p class="text-gray-400">–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<script>
// –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–º–∏ –∑–∞—è–≤–∫–∞–º–∏
class RequestManager {
    constructor() {
        this.container = document.getElementById("requests-list");
        this.alertBox = document.getElementById("new-alert");
        this.newCount = document.getElementById("new-count");
        this.loadingSpinner = document.getElementById("loading-spinner");
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –∏–∑ localStorage
        this.viewedRequests = new Set(this.getViewedRequestsFromStorage());
        this.lastRequestIds = this.getCurrentRequestIds();
        this.isUpdating = false;
        this.notifiedRequests = new Set(); // –ó–∞—è–≤–∫–∏, –ø–æ –∫–æ—Ç–æ—Ä—ã–º —É–∂–µ –±—ã–ª–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        
        console.log('üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∑–∞—è–≤–æ–∫');
        console.log('üëÄ –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏:', Array.from(this.viewedRequests));
        console.log('üìã –¢–µ–∫—É—â–∏–µ –∑–∞—è–≤–∫–∏:', this.lastRequestIds);
        
        this.init();
    }

    init() {
        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –Ω–µ–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
        this.highlightUnviewedRequests();
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤
        this.setupClickHandlers();
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
        this.startAutoRefresh();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
        this.updateUnviewedCount();
    }

    // üîπ –•–†–ê–ù–ï–ù–ò–ï –î–ê–ù–ù–´–•
    getViewedRequestsFromStorage() {
        try {
            const stored = localStorage.getItem('crm_viewed_requests');
            return stored ? JSON.parse(stored) : [];
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è localStorage:', e);
            return [];
        }
    }

    saveViewedRequestsToStorage() {
        try {
            localStorage.setItem('crm_viewed_requests', JSON.stringify(Array.from(this.viewedRequests)));
        } catch (e) {
            console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', e);
        }
    }

    getCurrentRequestIds() {
        const elements = this.container.querySelectorAll("[data-request-id]");
        return Array.from(elements).map(el => parseInt(el.dataset.requestId));
    }

    // üîπ –û–¢–ú–ï–¢–ö–ê –ó–ê–Ø–í–û–ö
    markRequestAsViewed(requestId) {
        const id = parseInt(requestId);
        if (!this.viewedRequests.has(id)) {
            this.viewedRequests.add(id);
            this.saveViewedRequestsToStorage();
            console.log('‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–∞—è:', id);
            
            // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
            this.removeHighlightFromRequest(id);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            this.updateUnviewedCount();
        }
    }

    async markAllRequestsAsViewed() {
        try {
            console.log('üîÑ –û—Ç–º–µ—á–∞–µ–º –≤—Å–µ –∑–∞—è–≤–∫–∏ –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ...');
            
            const response = await fetch('/crm/mark-all-viewed/', {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': this.getCSRFToken(),
                }
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                console.log('‚úÖ –í—Å–µ –∑–∞—è–≤–∫–∏ –æ—Ç–º–µ—á–µ–Ω—ã –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                const allIds = this.getCurrentRequestIds();
                allIds.forEach(id => {
                    if (!this.viewedRequests.has(id)) {
                        this.viewedRequests.add(id);
                        this.removeHighlightFromRequest(id);
                    }
                });
                
                this.saveViewedRequestsToStorage();
                this.updateUnviewedCount();
                
                // üîπ –£–ë–ò–†–ê–ï–ú –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
                this.hideAllNotifications();
                
                this.showTemporaryMessage(data.message, 'success');
            } else {
                throw new Error(data.error);
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –≤—Å–µ—Ö –∑–∞—è–≤–æ–∫:', error);
            this.showTemporaryMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ –∑–∞—è–≤–æ–∫', 'error');
        }
    }

    hideAllNotifications() {
        console.log('üîï –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ —Ö–µ–¥–µ—Ä–µ
        if (this.headerIndicator) {
            this.headerIndicator.classList.add('hidden');
        }
        
        // –°–∫—Ä—ã–≤–∞–µ–º –∞–ª–µ—Ä—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        if (this.alertBox) {
            this.alertBox.classList.add('hidden');
        }
        
        // üîπ –°–ë–†–ê–°–´–í–ê–ï–ú –°–û–°–¢–û–Ø–ù–ò–ï –í –ì–õ–û–ë–ê–õ–¨–ù–û–ô –°–ò–°–¢–ï–ú–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–ô
        if (window.globalNotifications) {
            window.globalNotifications.resetNotifications();
        }
        
        // –û—á–∏—â–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫
        this.notifiedRequests.clear();
    }

    // üîπ –ü–û–î–°–í–ï–¢–ö–ê
    highlightUnviewedRequests() {
        const allElements = this.container.querySelectorAll('[data-request-id]');
        let unviewedCount = 0;
        
        allElements.forEach(element => {
            const requestId = parseInt(element.dataset.requestId);
            
            if (!this.viewedRequests.has(requestId)) {
                // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É
                element.classList.add('new-request-highlight');
                unviewedCount++;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –±–µ–π–¥–∂
                if (!element.querySelector('.new-badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'new-badge absolute -top-2 -right-2 bg-red-500 text-white text-xs px-3 py-1 rounded-full font-medium';
                    badge.textContent = '–ù–û–í–ê–Ø';
                    element.style.position = 'relative';
                    element.appendChild(badge);
                }
            } else {
                // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —Å –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö
                this.removeHighlightFromRequest(requestId);
            }
        });
        
        console.log('üåü –ü–æ–¥—Å–≤–µ—á–µ–Ω–æ –∑–∞—è–≤–æ–∫:', unviewedCount);
    }

    removeHighlightFromRequest(requestId) {
        const element = this.container.querySelector(`[data-request-id="${requestId}"]`);
        if (element) {
            element.classList.remove('new-request-highlight');
            const badge = element.querySelector('.new-badge');
            if (badge) badge.remove();
        }
    }

    removeAllHighlights() {
        const elements = this.container.querySelectorAll('.new-request-highlight');
        elements.forEach(element => {
            element.classList.remove('new-request-highlight');
        });
        
        const badges = this.container.querySelectorAll('.new-badge');
        badges.forEach(badge => badge.remove());
    }

    // üîπ –°–ß–ï–¢–ß–ò–ö–ò –ò –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
    updateUnviewedCount() {
        const unviewedCount = this.getUnviewedCount();
        console.log('üìä –ù–µ–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫:', unviewedCount);
        
        if (unviewedCount > 0) {
            this.newCount.textContent = unviewedCount;
            this.alertBox.classList.remove('hidden');
        } else {
            this.alertBox.classList.add('hidden');
        }
        
        return unviewedCount;
    }

    getUnviewedCount() {
        const allIds = this.getCurrentRequestIds();
        return allIds.filter(id => !this.viewedRequests.has(id)).length;
    }

    // üîπ –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –û –ù–û–í–´–• –ó–ê–Ø–í–ö–ê–•
    checkForNewRequests(newIds) {
        const newRequests = newIds.filter(id => !this.lastRequestIds.includes(id));
        const unviewedNewRequests = newRequests.filter(id => !this.viewedRequests.has(id));
        
        console.log('üÜï –ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏:', newRequests);
        console.log('üëÄ –ù–µ–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ –Ω–æ–≤—ã–µ:', unviewedNewRequests);
        
        // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞—è–≤–∫–∏, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –µ—â–µ –Ω–µ –±—ã–ª–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const newUnnotifiedRequests = unviewedNewRequests.filter(id => !this.notifiedRequests.has(id));
        
        if (newUnnotifiedRequests.length > 0) {
            console.log('üîî –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è', newUnnotifiedRequests.length, '–Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫');
            this.showNotification(newUnnotifiedRequests.length);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–Ω—ã—Ö
            newUnnotifiedRequests.forEach(id => this.notifiedRequests.add(id));
            
            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –Ω–æ–≤—ã–µ –∑–∞—è–≤–∫–∏
            newUnnotifiedRequests.forEach(id => {
                const element = this.container.querySelector(`[data-request-id="${id}"]`);
                if (element) {
                    element.classList.add('new-request-highlight', 'pulse-animation');
                    
                    if (!element.querySelector('.new-badge')) {
                        const badge = document.createElement('span');
                        badge.className = 'new-badge absolute -top-2 -right-2 bg-red-500 text-white text-xs px-3 py-1 rounded-full font-medium';
                        badge.textContent = '–ù–û–í–ê–Ø';
                        element.style.position = 'relative';
                        element.appendChild(badge);
                    }
                }
            });
        }
        
        return unviewedNewRequests;
    }

    // üîπ –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–õ–ò–ö–û–í
    setupClickHandlers() {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏
        document.addEventListener('click', (e) => {
            // –ö–ª–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É "–ü–æ–¥—Ä–æ–±–Ω–µ–µ"
            if (e.target.closest('.view-request-btn')) {
                const requestItem = e.target.closest('.request-item');
                if (requestItem) {
                    const requestId = requestItem.dataset.requestId;
                    console.log('üëÜ –ö–ª–∏–∫ –Ω–∞ –∑–∞—è–≤–∫—É:', requestId);
                    this.markRequestAsViewed(requestId);
                    this.markRequestAsViewedOnServer(requestId);
                }
            }
            
            // –ö–ª–∏–∫ –Ω–∞ —Å–∞–º—É –∑–∞—è–≤–∫—É
            if (e.target.closest('.request-item') && !e.target.closest('a') && !e.target.closest('button')) {
                const requestItem = e.target.closest('.request-item');
                if (requestItem) {
                    const requestId = requestItem.dataset.requestId;
                    console.log('üëÜ –ö–ª–∏–∫ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É –∑–∞—è–≤–∫–∏:', requestId);
                    this.markRequestAsViewed(requestId);
                    this.markRequestAsViewedOnServer(requestId);
                }
            }
        });
    }

    async markRequestAsViewedOnServer(requestId) {
        try {
            const response = await fetch(`/crm/request/${requestId}/mark-viewed/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': this.getCSRFToken(),
                }
            });
            
            const data = await response.json();
            if (data.status === 'success') {
                console.log('‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–∞—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:', requestId);
            }
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ –∑–∞—è–≤–∫–∏ –∫–∞–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ–π:', error);
        }
    }

    getCSRFToken() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        return csrfToken ? csrfToken.value : '';
    }

    // üîπ –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–ï
    async loadRequests() {
        if (this.isUpdating) return;
        
        this.isUpdating = true;
        this.loadingSpinner.classList.remove("hidden");
        
        try {
            console.log('üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π...');
            const currentUrl = window.location.href;
            
            const response = await fetch(currentUrl, { 
                headers: { 
                    "X-Requested-With": "XMLHttpRequest",
                },
                cache: 'no-cache'
            });
            
            if (!response.ok) throw new Error('HTTP error: ' + response.status);
            
            const html = await response.text();
            
            if (!html.trim()) {
                console.log('üì≠ –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                return;
            }
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            
            const newContainer = tempDiv.querySelector("#requests-list");
            if (!newContainer) {
                console.log('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–∞—è–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ');
                return;
            }
            
            const newElements = newContainer.querySelectorAll("[data-request-id]");
            const newIds = Array.from(newElements).map(el => parseInt(el.dataset.requestId));
            
            console.log('üÜï –ù–æ–≤—ã–µ ID:', newIds);
            console.log('üìã –°—Ç–∞—Ä—ã–µ ID:', this.lastRequestIds);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
            const hasChanges = JSON.stringify(newIds) !== JSON.stringify(this.lastRequestIds);
            
            if (hasChanges) {
                console.log('üîÑ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è!');
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ ID –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫
                const currentViewed = new Set(this.viewedRequests);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
                this.container.innerHTML = newContainer.innerHTML;
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                this.setupClickHandlers();
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫
                this.viewedRequests = currentViewed;
                this.saveViewedRequestsToStorage();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                this.checkForNewRequests(newIds);
                
                // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –Ω–µ–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
                this.highlightUnviewedRequests();
                
                this.lastRequestIds = newIds;
                this.updateUnviewedCount();
            } else {
                console.log('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç');
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
        } finally {
            this.isUpdating = false;
            this.loadingSpinner.classList.add("hidden");
        }
    }

    startAutoRefresh() {
        console.log('üîÑ –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ä–∞–∑—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        setTimeout(() => this.loadRequests(), 3000);
        
        // –ó–∞—Ç–µ–º –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            this.loadRequests();
        }, 15000);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                console.log('üëÄ –í–∫–ª–∞–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞, –æ–±–Ω–æ–≤–ª—è–µ–º...');
                this.loadRequests();
            }
        });
    }

    showNotification(count) {
        console.log('üîî –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:', count);
        this.newCount.textContent = count;
        this.alertBox.classList.remove("hidden");
        
        // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
        setTimeout(() => {
            this.alertBox.classList.add("hidden");
        }, 5000);
        
        // –¢–∞–∫–∂–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–æ–¥–∏–Ω —Ä–∞–∑)
        if (window.globalNotifications && !this.globalNotificationShown) {
            window.globalNotifications.showAlert(count);
            this.globalNotificationShown = true;
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —á–µ—Ä–µ–∑ 1 –º–∏–Ω—É—Ç—É
            setTimeout(() => {
                this.globalNotificationShown = false;
            }, 60000);
        }
    }

    showTemporaryMessage(message, type = 'info') {
        const messageDiv = document.createElement('div');
        messageDiv.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg shadow-lg ${
            type === 'success' ? 'bg-green-500 text-white' : 'bg-blue-500 text-white'
        }`;
        messageDiv.textContent = message;
        document.body.appendChild(messageDiv);
        
        setTimeout(() => {
            document.body.removeChild(messageDiv);
        }, 3000);
    }
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
async function markAllAsViewed() {
    if (window.requestManager) {
        await window.requestManager.markAllRequestsAsViewed();
    } else {
        console.error('‚ùå RequestManager –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener("DOMContentLoaded", function() {
    console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –∑–∞—è–≤–æ–∫...');
    window.requestManager = new RequestManager();
});
</script>

<style>
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

@keyframes borderGlow {
    0%, 100% { border-left-color: #10b981; }
    50% { border-left-color: #34d399; }
}

@keyframes pulseGlow {
    0% { box-shadow: 0 0 5px rgba(34, 197, 94, 0.5); }
    50% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.8); }
    100% { box-shadow: 0 0 5px rgba(34, 197, 94, 0.5); }
}

.hidden {
    display: none !important;
}

/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–µ–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫ */
.new-request-highlight {
    border-left: 4px solid #10b981 !important;
    background: linear-gradient(90deg, #f0fdf4 0%, #ffffff 30%) !important;
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.15) !important;
    animation: borderGlow 2s ease-in-out infinite;
}

.pulse-animation {
    animation: pulseGlow 2s ease-in-out 3;
}

.new-badge {
    animation: pulse 1s ease-in-out infinite;
    z-index: 10;
}

.request-item {
    transition: all 0.3s ease;
    position: relative;
}

#loading-spinner {
    transition: opacity 0.3s ease;
}

#new-alert {
    animation: fadeIn 0.5s ease-out;
}
</style>
{% endblock %}