{% extends "crm/base_crm.html" %}
{% load static %}

{% block title %}–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É - CRM –ê—Ä–≥—É—Å{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-xl shadow-sm p-6 md:p-8">
        <div class="flex items-center gap-3 mb-6">
            <a href="{% url 'crm_my_requests' %}" class="text-gray-500 hover:text-gray-700">
                <i data-lucide="arrow-left" class="w-5 h-5"></i>
            </a>
            <h1 class="text-2xl font-bold text-gray-800">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É</h1>
        </div>

        <form id="requestForm" method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}

            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ -->
            <div>
                <label for="company_name" class="block text-gray-700 mb-2 font-medium">
                    –ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ <span class="text-red-500">*</span>
                </label>
                <input type="text" id="company_name" name="company_name" placeholder="–û–û–û –ü—Ä–∏–º–µ—Ä"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
            </div>

            <!-- –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ -->
            <div>
                <label for="contact_person" class="block text-gray-700 mb-2 font-medium">
                    –ö–æ–Ω—Ç–∞–∫—Ç–Ω–æ–µ –ª–∏—Ü–æ <span class="text-red-500">*</span>
                </label>
                <input type="text" id="contact_person" name="contact_person" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
            </div>

            <!-- –¢–µ–ª–µ—Ñ–æ–Ω –∏ Email -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="phone" class="block text-gray-700 mb-2 font-medium">
                        –¢–µ–ª–µ—Ñ–æ–Ω <span class="text-red-500">*</span>
                    </label>
                    <input type="tel" id="phone" name="phone" placeholder="+7 (999) 123-45-67"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                </div>

                <div>
                    <label for="email" class="block text-gray-700 mb-2 font-medium">
                        Email <span class="text-red-500">*</span>
                    </label>
                    <input type="email" id="email" name="email" placeholder="example@company.ru"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
            </div>

            <!-- –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞ -->
            <div>
                <label for="object_type" class="block text-gray-700 mb-2 font-medium">
                    –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞ <span class="text-red-500">*</span>
                </label>
                <select id="object_type" name="object_type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞</option>
                    <option value="residential">–ñ–∏–ª–æ–µ –∑–¥–∞–Ω–∏–µ</option>
                    <option value="industrial">–ü—Ä–æ–º—ã—à–ª–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç</option>
                    <option value="commercial">–¢–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä</option>
                    <option value="office">–û—Ñ–∏—Å</option>
                    <option value="government">–ì–æ—Å. —É—á—Ä–µ–∂–¥–µ–Ω–∏–µ</option>
                </select>
            </div>

            <!-- –ê–¥—Ä–µ—Å -->
            <div>
                <label for="object_address" class="block text-gray-700 mb-2 font-medium">
                    –ê–¥—Ä–µ—Å –æ–±—ä–µ–∫—Ç–∞
                </label>
                <textarea id="object_address" name="object_address" rows="2"
                          placeholder="–≥. –ö–∞–∑–∞–Ω—å, —É–ª. –õ–µ–Ω–∏–Ω–∞, –¥. 10"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>

            <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
            <div>
                <label for="description" class="block text-gray-700 mb-2 font-medium">
                    üìù –û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏
                </label>
                <textarea id="description" name="description" rows="4"
                          placeholder="–û–ø–∏—à–∏—Ç–µ –æ–±—ä–µ–∫—Ç, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏, –ø–æ–∂–µ–ª–∞–Ω–∏—è..."
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>

            <!-- –£—Å–ª—É–≥–∏ -->
            <div>
                <label class="block text-gray-700 mb-3 font-medium">
                    –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥–∏ <span class="text-red-500">*</span>
                </label>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    {% for service in services %}
                    <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors">
                        <input type="checkbox" name="services" value="{{ service.id }}"
                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                        <span class="text-gray-700">{{ service.name }}</span>
                    </label>
                    {% empty %}
                    <div class="col-span-2 text-center py-4 text-gray-500">
                        –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —É—Å–ª—É–≥
                    </div>
                    {% endfor %}
                </div>
                <p id="servicesError" class="text-red-500 text-sm mt-2 hidden">–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —É—Å–ª—É–≥—É</p>
            </div>

            <!-- –§–∞–π–ª -->
            <div>
                <label class="block text-gray-700 mb-2 font-medium">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</label>
                <div id="file-drop" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-blue-500 transition">
                    <input type="file" id="fileInput" name="attached_file" class="hidden" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
                    <p id="fileLabel" class="text-gray-500">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</p>
                    <p id="fileName" class="text-gray-700 mt-2 font-medium hidden"></p>
                    <button type="button" id="removeFileBtn" class="text-red-500 mt-2 hidden hover:underline text-sm">–£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª</button>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ -->
            <div class="flex gap-3 pt-4">
                <a href="{% url 'crm_my_requests' %}" 
                   class="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-center font-medium">
                    –û—Ç–º–µ–Ω–∞
                </a>
                <button type="submit"
                        class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium flex items-center justify-center gap-2">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        lucide.createIcons();

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
        const drop = document.getElementById('file-drop');
        const input = document.getElementById('fileInput');
        const fileName = document.getElementById('fileName');
        const removeBtn = document.getElementById('removeFileBtn');
        const label = document.getElementById('fileLabel');

        drop.addEventListener('click', () => input.click());
        
        input.addEventListener('change', e => {
            const file = e.target.files[0];
            if (file) {
                fileName.textContent = `üìé ${file.name}`;
                fileName.classList.remove('hidden');
                removeBtn.classList.remove('hidden');
                label.classList.add('hidden');
            }
        });
        
        removeBtn.addEventListener('click', () => {
            input.value = '';
            fileName.classList.add('hidden');
            removeBtn.classList.add('hidden');
            label.classList.remove('hidden');
        });

        // Drag and drop –¥–ª—è —Ñ–∞–π–ª–æ–≤
        drop.addEventListener('dragover', (e) => {
            e.preventDefault();
            drop.classList.add('border-blue-500', 'bg-blue-50');
        });

        drop.addEventListener('dragleave', () => {
            drop.classList.remove('border-blue-500', 'bg-blue-50');
        });

        drop.addEventListener('drop', (e) => {
            e.preventDefault();
            drop.classList.remove('border-blue-500', 'bg-blue-50');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                input.files = files;
                const file = files[0];
                fileName.textContent = `üìé ${file.name}`;
                fileName.classList.remove('hidden');
                removeBtn.classList.remove('hidden');
                label.classList.add('hidden');
            }
        });

        // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
        document.getElementById('requestForm').addEventListener('submit', function(e) {
            let valid = true;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
            ['company_name', 'contact_person', 'phone', 'email', 'object_type'].forEach(id => {
                const field = document.getElementById(id);
                if (!field.value.trim()) {
                    field.classList.add('border-red-500');
                    valid = false;
                } else {
                    field.classList.remove('border-red-500');
                }
            });

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥
            const checkedServices = document.querySelectorAll('input[name="services"]:checked');
            const servicesError = document.getElementById('servicesError');
            if (checkedServices.length === 0) {
                servicesError.classList.remove('hidden');
                valid = false;
            } else {
                servicesError.classList.add('hidden');
            }

            if (!valid) {
                e.preventDefault();
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —É—Å–ª—É–≥—É');
            }
        });

        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥
        document.querySelectorAll('input[name="services"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const label = this.closest('label');
                if (this.checked) {
                    label.classList.add('bg-blue-50', 'border-blue-300');
                } else {
                    label.classList.remove('bg-blue-50', 'border-blue-300');
                }
            });
        });
    });
</script>

<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —É—Å–ª—É–≥ */
    input[name="services"]:checked + span {
        font-weight: 600;
        color: #1f2937;
    }
</style>
{% endblock %}