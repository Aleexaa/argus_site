{% extends 'crm/base_crm.html' %}
{% load static %}

{% block title %}–ó–∞—è–≤–∫–∞ #{{ req.id }}{% endblock %}

{% block content %}
<div class="bg-white rounded-2xl p-6 shadow-soft">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-semibold text-gray-800">
            –ó–∞—è–≤–∫–∞ #{{ req.id }} –æ—Ç {{ req.client.company_name }}
        </h2>
        <span id="update-alert" class="hidden text-sm bg-green-500/20 text-green-600 px-3 py-2 rounded-lg border border-green-500/30 shadow-sm">
            üîî –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!
        </span>
    </div>

    <div class="grid md:grid-cols-2 gap-6">
        <div>
            <p><span class="font-semibold text-gray-700">–ê–¥—Ä–µ—Å:</span> {{ req.object_address|default:"‚Äî" }}</p>
            <p><span class="font-semibold text-gray-700">–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞:</span> {{ req.object_type }}</p>
            <p><span class="font-semibold text-gray-700">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</span> {{ req.created_at|date:"d.m.Y H:i" }}</p>
            <p><span class="font-semibold text-gray-700">–ö–ª–∏–µ–Ω—Ç:</span> {{ req.client.contact_person|default:"‚Äî" }} ({{ req.client.email|default:"‚Äî" }})</p>
            
            <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–µ–Ω–µ–¥–∂–µ—Ä–µ -->
            <div class="mt-4">
                <p class="font-semibold text-gray-700">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä:</p>
                {% if req.responsible_manager %}
                    <p class="text-gray-600">{{ req.responsible_manager.user.get_full_name|default:req.responsible_manager.user.username }}</p>
                {% else %}
                    <p class="text-gray-400">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</p>
                {% endif %}
            </div>

            {% if req.attached_file %}
                <div class="mt-4">
                    <h3 class="text-lg font-semibold text-gray-800">üìé –ü—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª:</h3>
                    <a href="{% url 'crm_download_file' req.id %}" 
                       target="_blank" 
                       class="inline-flex items-center px-4 py-2 bg-gold text-black rounded-lg hover:bg-amber-600 transition-colors">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª: {{ req.attached_file.name|cut:"requests/" }}
                    </a>
                    <p class="text-sm text-gray-500 mt-1">
                        –†–∞–∑–º–µ—Ä: {{ req.attached_file.size|filesizeformat }}
                    </p>
                </div>
            {% else %}
                <p class="text-gray-400 mt-4">–§–∞–π–ª –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª—ë–Ω.</p>
            {% endif %}

            {% if req.description %}
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-800">üìù –û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞:</h3>
                    <p class="text-gray-600 whitespace-pre-line">{{ req.description }}</p>
                </div>
            {% endif %}

            {% if req.services.exists %}
                <div class="mt-6">
                    <h3 class="text-lg font-semibold text-gray-800">üîß –£—Å–ª—É–≥–∏:</h3>
                    <ul class="list-disc list-inside text-gray-600">
                        {% for service in req.services.all %}
                            <li>{{ service.name }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% else %}
                <p class="text-gray-400 mt-4">–£—Å–ª—É–≥–∏ –Ω–µ —É–∫–∞–∑–∞–Ω—ã.</p>
            {% endif %}
        </div>

        <!-- –§–æ—Ä–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞, –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
        <div>
            <form method="post" id="update-form" class="space-y-4">
                {% csrf_token %}
                
                <!-- –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ -->
                <div>
                    <label class="block text-gray-700 mb-1 font-medium">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä</label>
                    <select name="manager" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-gold">
                        <option value="">‚Äî –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω ‚Äî</option>
                        {% for manager in managers %}
                            <option value="{{ manager.id }}" {% if req.responsible_manager and req.responsible_manager.id == manager.id %}selected{% endif %}>
                                {{ manager.user.get_full_name|default:manager.user.username }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- –°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ -->
                <div>
                    <label class="block text-gray-700 mb-1 font-medium">–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏</label>
                    <select name="status" class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-gold">
                        {% for key, value in req.STATUS_CHOICES %}
                            <option value="{{ key }}" {% if key == req.status %}selected{% endif %}>
                                {{ value }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
                <div>
                    <label class="block text-gray-700 mb-1 font-medium">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <textarea name="comment" rows="3" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-gold"></textarea>
                </div>

                <button type="submit" class="btn-gold px-4 py-2 rounded-lg flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                </button>
            </form>
        </div>
    </div>
</div>

<!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
<div class="mt-10" id="comments-block">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-semibold text-gray-800">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</h3>
        <span id="comments-loading" class="hidden text-sm text-blue-500">
            <svg class="animate-spin h-4 w-4 mr-1 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...
        </span>
    </div>
    
    {% if comments %}
        <div class="space-y-4" id="comments-list">
            {% for comment in comments %}
                <div class="bg-white shadow-soft rounded-xl p-4 border-l-4 border-[#C9A96A] comment-item" data-comment-id="{{ comment.id }}">
                    <p class="text-gray-700 mb-1">{{ comment.text }}</p>
                    <p class="text-sm text-gray-500">
                        {{ comment.author.user.get_full_name|default:comment.author.user.username }}
                        ‚Äî {{ comment.created_at|date:"d.m.Y H:i" }}
                    </p>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="text-gray-500 italic">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</p>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector("#update-form");
    const commentsBlock = document.querySelector("#comments-block");
    const updateAlert = document.querySelector("#update-alert");
    const commentsLoading = document.querySelector("#comments-loading");
    
    let lastCommentIds = getCurrentCommentIds();
    let isUpdating = false;

    function getCurrentCommentIds() {
        const elements = document.querySelectorAll(".comment-item");
        return Array.from(elements).map(el => parseInt(el.dataset.commentId));
    }

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
            type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
        }`;
        notification.textContent = message;
        notification.style.animation = 'slideInRight 0.5s ease-out';
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.5s ease-in';
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 500);
        }, 3000);
    }

    function showUpdateAlert() {
        updateAlert.classList.remove('hidden');
        updateAlert.style.animation = 'fadeIn 0.5s ease-out';
        
        setTimeout(() => {
            updateAlert.style.opacity = '0';
            updateAlert.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
                updateAlert.classList.add('hidden');
                updateAlert.style.opacity = '1';
                updateAlert.style.transition = '';
            }, 500);
        }, 3000);
    }

    // üîÅ AJAX —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ - –£–ü–†–û–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
    form.addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const submitButton = this.querySelector('button[type="submit"]');
        const originalText = submitButton.innerHTML;
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        submitButton.innerHTML = `
            <svg class="animate-spin h-4 w-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...
        `;
        submitButton.disabled = true;

        fetch(window.location.href, {
            method: "POST",
            headers: { 
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRFToken": "{{ csrf_token }}" 
            },
            body: formData,
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.text();
        })
        .then(html => {
            // –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            window.location.reload();
        })
        .catch(err => {
            console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", err);
            showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'error');
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
            submitButton.innerHTML = originalText;
            submitButton.disabled = false;
        });
    });

    // ‚è± –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ - –£–ü–†–û–©–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
    function loadComments() {
        if (isUpdating || document.hidden) return;
        
        isUpdating = true;
        commentsLoading.classList.remove("hidden");
        
        fetch(window.location.href, { 
            headers: { "X-Requested-With": "XMLHttpRequest" },
            cache: 'no-cache'
        })
        .then(response => {
            if (!response.ok) throw new Error('Network response was not ok');
            return response.text();
        })
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newCommentsBlock = doc.querySelector('#comments-block');
            
            if (newCommentsBlock) {
                const newCommentsList = newCommentsBlock.querySelector('#comments-list');
                const newCommentItems = newCommentsList ? newCommentsList.querySelectorAll('.comment-item') : [];
                const newCommentIds = Array.from(newCommentItems).map(el => parseInt(el.dataset.commentId));
                
                const newComments = newCommentIds.filter(id => !lastCommentIds.includes(id));
                
                if (newComments.length > 0) {
                    commentsBlock.innerHTML = newCommentsBlock.innerHTML;
                    lastCommentIds = newCommentIds;
                    showUpdateAlert();
                } else if (newCommentIds.length !== lastCommentIds.length) {
                    commentsBlock.innerHTML = newCommentsBlock.innerHTML;
                    lastCommentIds = newCommentIds;
                }
            }
        })
        .catch(err => console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:", err))
        .finally(() => {
            isUpdating = false;
            commentsLoading.classList.add("hidden");
        });
    }

    // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
    setInterval(loadComments, 10000);

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            loadComments();
        }
    });

    // –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(loadComments, 5000);
});
</script>

<style>
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
@keyframes slideInRight {
    from { opacity: 0; transform: translateX(100%); }
    to { opacity: 1; transform: translateX(0); }
}
@keyframes slideOutRight {
    from { opacity: 1; transform: translateX(0); }
    to { opacity: 0; transform: translateX(100%); }
}
.hidden { display: none !important; }
.btn-gold {
    background: linear-gradient(135deg, #C9A96A 0%, #B89450 100%);
    color: white; border: none; cursor: pointer;
    transition: all 0.3s ease;
}
.btn-gold:hover {
    background: linear-gradient(135deg, #B89450 0%, #A88340 100%);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(201, 169, 106, 0.3);
}
.btn-gold:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}
</style>
{% endblock %}