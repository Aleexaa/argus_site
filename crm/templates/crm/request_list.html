{% extends 'crm/base_crm.html' %}
{% load static %}

{% block title %}–ó–∞—è–≤–∫–∏ | CRM –ê—Ä–≥—É—Å{% endblock %}

{% block content %}
<div class="flex items-center justify-between mb-6">
  <h2 class="text-2xl font-semibold text-dark flex items-center gap-3">
    üìã –°–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫
    <span id="loading-spinner" class="hidden text-sm text-blue-500">
      <svg class="animate-spin h-5 w-5 mr-2 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...
    </span>
  </h2>
  <span id="new-alert"
        class="hidden text-sm bg-green-500/20 text-green-600 px-3 py-2 rounded-lg border border-green-500/30 shadow-sm">
    üîî <span id="new-count">0</span> –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫!
  </span>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã –ø–æ —Å—Ç–∞—Ç—É—Å—É -->
<div class="mb-6 flex gap-2 flex-wrap">
  <a href="{% url 'crm_requests' %}" class="px-3 py-1 text-sm rounded-full {% if not status_filter %}bg-gold text-white{% else %}bg-gray-200 text-gray-700{% endif %}">
    –í—Å–µ
  </a>
  <a href="?status=new" class="px-3 py-1 text-sm rounded-full {% if status_filter == 'new' %}bg-blue-500 text-white{% else %}bg-gray-200 text-gray-700{% endif %}">
    –ù–æ–≤—ã–µ
  </a>
  <a href="?status=in_progress" class="px-3 py-1 text-sm rounded-full {% if status_filter == 'in_progress' %}bg-yellow-500 text-white{% else %}bg-gray-200 text-gray-700{% endif %}">
    –í —Ä–∞–±–æ—Ç–µ
  </a>
  <a href="?status=completed" class="px-3 py-1 text-sm rounded-full {% if status_filter == 'completed' %}bg-green-500 text-white{% else %}bg-gray-200 text-gray-700{% endif %}">
    –ó–∞–≤–µ—Ä—à–µ–Ω—ã
  </a>
  <a href="?status=cancelled" class="px-3 py-1 text-sm rounded-full {% if status_filter == 'cancelled' %}bg-red-500 text-white{% else %}bg-gray-200 text-gray-700{% endif %}">
    –û—Ç–º–µ–Ω–µ–Ω—ã
  </a>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ –∑–∞—è–≤–æ–∫ -->
<div id="requests-list" class="space-y-4">
  {% include 'crm/partials/requests_list.html' %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  const container = document.getElementById("requests-list");
  const alertBox = document.getElementById("new-alert");
  const newCount = document.getElementById("new-count");
  const loadingSpinner = document.getElementById("loading-spinner");
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ ID –∑–∞—è–≤–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  let lastIds = getCurrentRequestIds();
  let isUpdating = false;

  function getCurrentRequestIds() {
    const elements = container.querySelectorAll("[data-request-id]");
    return Array.from(elements).map(el => parseInt(el.dataset.requestId));
  }

  async function loadRequests() {
    if (isUpdating) return;
    
    isUpdating = true;
    loadingSpinner.classList.remove("hidden");
    
    try {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL (—Ñ–∏–ª—å—Ç—Ä—ã)
      const currentUrl = window.location.href;
      
      const response = await fetch(currentUrl, { 
        headers: { 
          "X-Requested-With": "XMLHttpRequest",
        },
        cache: 'no-cache'
      });
      
      if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + response.status);
      
      const html = await response.text();
      
      // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ HTML
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = html;
      
      // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∑–∞—è–≤–æ–∫
      const newElements = tempDiv.querySelectorAll("[data-request-id]");
      const newIds = Array.from(newElements).map(el => parseInt(el.dataset.requestId));
      
      console.log('–°—Ç–∞—Ä—ã–µ ID:', lastIds);
      console.log('–ù–æ–≤—ã–µ ID:', newIds);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–µ –∑–∞—è–≤–∫–∏
      const newOnes = newIds.filter(id => !lastIds.includes(id));
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å –Ω–æ–≤—ã–µ –∑–∞—è–≤–∫–∏, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
      if (newOnes.length > 0) {
        console.log('–ù–∞–π–¥–µ–Ω—ã –Ω–æ–≤—ã–µ –∑–∞—è–≤–∫–∏:', newOnes);
        showNotification(newOnes.length);
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      container.innerHTML = html;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ ID
      lastIds = newIds;
      
    } catch (error) {
      console.error("–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–æ–∫:", error);
    } finally {
      isUpdating = false;
      loadingSpinner.classList.add("hidden");
    }
  }

  function showNotification(count) {
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    newCount.textContent = count;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    alertBox.classList.remove("hidden");
    alertBox.style.animation = 'fadeIn 0.5s ease-out';
    
    // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
      alertBox.style.opacity = '0';
      alertBox.style.transition = 'opacity 0.5s ease';
      
      setTimeout(() => {
        alertBox.classList.add("hidden");
        alertBox.style.opacity = '1';
        alertBox.style.transition = '';
        alertBox.style.animation = '';
      }, 500);
    }, 5000);
  }

  // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 8 —Å–µ–∫—É–Ω–¥
  setInterval(loadRequests, 8000);
  
  // –¢–∞–∫–∂–µ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
  document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
      loadRequests();
    }
  });
});
</script>

<style>
@keyframes fadeIn {
  from { 
    opacity: 0; 
    transform: translateY(-10px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
}

.hidden {
  display: none !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –ø–ª–∞–≤–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ */
#requests-list > div {
  transition: all 0.3s ease;
}
</style>
{% endblock %}