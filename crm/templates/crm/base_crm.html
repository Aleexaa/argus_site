{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CRM –ê—Ä–≥—É—Å{% endblock %}</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f8fa;
        }
        .bg-dark-blue { background-color: #0D1B2A; }
        .text-gold { color: #C9A96A; }
        .hover-gold:hover { color: #C9A96A; }

        .btn-gold {
            background-color: #C9A96A;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-gold:hover {
            background-color: #b9925b;
            transform: translateY(-1px);
        }

        .btn-logout {
            background-color: #b9925b;
            color: white;
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .btn-logout:hover {
            background-color: #b91c1c;
            transform: translateY(-1px);
        }

        .shadow-soft {
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        .nav-link {
            color: #d1d5db;
            font-weight: 500;
            transition: color 0.2s ease;
        }
        .nav-link:hover { color: #ffffff; }
        .nav-active {
            color: #C9A96A !important;
            font-weight: 600;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideOutRight {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 0 5px rgba(34, 197, 94, 0.5);
            }
            50% {
                box-shadow: 0 0 20px rgba(34, 197, 94, 0.8);
            }
        }

        .notification-pulse {
            animation: pulseGlow 2s infinite;
        }

        .badge-pulse {
            animation: pulseGlow 1.5s infinite;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏ */
        .new-request-appear {
            animation: slideInDown 0.5s ease-out;
        }

        /* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫ */
        .new-request-highlight {
            border-left: 4px solid #10b981 !important;
            background: linear-gradient(90deg, #f0fdf4 0%, #ffffff 30%) !important;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.15) !important;
        }

        .pulse-animation {
            animation: pulseGlow 2s ease-in-out 3;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">
    <!-- üîπ –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–∫–∞—Ö -->
    <div id="global-requests-alert" class="hidden fixed top-20 right-4 z-50 bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg border-l-4 border-green-600 cursor-pointer max-w-sm">
        <div class="flex items-center gap-3">
            <span class="text-lg">üîî</span>
            <div class="flex-1">
                <div class="font-semibold" id="global-alert-text">–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏!</div>
                <div class="text-xs opacity-90">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</div>
            </div>
            <button onclick="hideGlobalAlert()" class="ml-2 text-white hover:text-gray-200 text-lg">
                ‚úï
            </button>
        </div>
    </div>

    <!-- üîπ –í–µ—Ä—Ö–Ω–µ–µ –º–µ–Ω—é -->
    <header class="bg-dark-blue shadow-md text-white sticky top-0 z-40">
        <div class="container mx-auto flex justify-between items-center px-6 py-4">
            <div class="flex items-center gap-6">
                <h1 class="text-xl md:text-2xl font-bold tracking-wide">
                    CRM <span class="text-gold">–ê—Ä–≥—É—Å</span>
                </h1>

                <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
                <nav class="flex flex-wrap gap-6 text-sm md:text-base items-center">
                    <a href="{% url 'crm_dashboard' %}" 
                       class="nav-link {% if request.path == '/crm/' %}nav-active{% endif %}">
                       –í—Å–µ –∑–∞—è–≤–∫–∏
                    </a>
                    <a href="{% url 'crm_my_requests' %}" 
                       class="nav-link {% if '/crm/my-requests' in request.path %}nav-active{% endif %}">
                       –ú–æ–∏ –∑–∞—è–≤–∫–∏
                    </a>
                    <a href="{% url 'crm_clients' %}" 
                       class="nav-link {% if '/crm/clients' in request.path %}nav-active{% endif %}">
                       –í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã
                    </a>
                    <a href="{% url 'crm_projects' %}" 
                       class="nav-link {% if '/crm/projects' in request.path %}nav-active{% endif %}">
                       –ü—Ä–æ–µ–∫—Ç—ã
                    </a>

                    {% if request.user.managerprofile.role == 'owner' %}
                    <a href="{% url 'crm_managers' %}" 
                       class="nav-link {% if '/crm/managers' in request.path %}nav-active{% endif %}">
                       –ú–µ–Ω–µ–¥–∂–µ—Ä—ã
                    </a>
                    {% endif %}

                    <a href="{% url 'crm_profile' %}" 
                       class="nav-link {% if '/crm/profile' in request.path %}nav-active{% endif %}">
                       –ü—Ä–æ—Ñ–∏–ª—å
                    </a>
                </nav>
            </div>

            <!-- üîπ –ö–Ω–æ–ø–∫–∏ —Å–ø—Ä–∞–≤–∞ -->
            <div class="flex items-center gap-3">
                <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫ -->
                <div id="header-notification" class="hidden items-center gap-2 px-3 py-1 bg-red-500 text-white rounded-full text-sm font-medium notification-pulse mr-2">
                    <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
                    <span id="header-notification-count">0</span>
                    <span>–Ω–æ–≤—ã—Ö</span>
                </div>

                <!-- –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
                <span class="text-sm text-gray-300">
                    {{ request.user.get_full_name|default:request.user.username }}
                </span>

                {% if request.user.managerprofile.role == 'manager' %}
                <a href="{% url 'crm_add_project' %}" class="btn-gold px-4 py-2 rounded-lg text-sm font-medium">
                    + –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç
                </a>
                {% endif %}
                
                <a href="{% url 'logout' %}" class="btn-logout flex items-center gap-1 text-sm">
                    <i data-lucide="log-out" class="w-4 h-4"></i> –í—ã–π—Ç–∏
                </a>
            </div>
        </div>
    </header>

    <!-- üîπ –ö–æ–Ω—Ç–µ–Ω—Ç -->
    <main class="flex-1 container mx-auto px-6 py-8">
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        {% if messages %}
        <div class="mb-6">
            {% for message in messages %}
            <div class="p-4 rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-700{% else %}bg-green-100 text-green-700{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% block content %}{% endblock %}
    </main>

    <!-- üîπ –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ -->
    <script>
        class GlobalNotifications {
            constructor() {
                this.alertElement = document.getElementById('global-requests-alert');
                this.alertText = document.getElementById('global-alert-text');
                this.headerIndicator = document.getElementById('header-notification');
                this.headerCount = document.getElementById('header-notification-count');
                
                this.isChecking = false;
                this.checkInterval = 10000; // 10 —Å–µ–∫—É–Ω–¥
                this.lastCount = 0;
                this.displayedRequests = new Set(); // –ó–∞—è–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω—ã
                
                this.init();
            }

            init() {
                console.log('üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...');
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Å—Ä–∞–∑—É
                setTimeout(() => this.checkForNewRequests(), 2000);
                
                // –ó–∞—Ç–µ–º –ø–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª—É
                setInterval(() => this.checkForNewRequests(), this.checkInterval);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden) {
                        console.log('üëÄ –í–∫–ª–∞–¥–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–µ –∑–∞—è–≤–∫–∏...');
                        this.checkForNewRequests();
                    }
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ - –ü–ï–†–ï–•–û–î–ò–ú –ù–ê –°–¢–†–ê–ù–ò–¶–£
                if (this.alertElement) {
                    this.alertElement.addEventListener('click', () => {
                        window.location.href = "{% url 'crm_dashboard' %}";
                    });
                }

                console.log('‚úÖ –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
            }

            async checkForNewRequests() {
                if (this.isChecking) {
                    return;
                }
                
                this.isChecking = true;
                try {
                    console.log('üîç –ó–∞–ø—Ä–æ—Å –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫ —Å –¥–∞–Ω–Ω—ã–º–∏...');
                    
                    const response = await fetch('{% url "crm_check_new_requests" %}', {
                        method: 'GET',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                        },
                        cache: 'no-store'
                    });

                    console.log('üì® –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω, —Å—Ç–∞—Ç—É—Å:', response.status);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('üìä –î–∞–Ω–Ω—ã–µ –æ –∑–∞—è–≤–∫–∞—Ö:', data);
                        
                        if (data.status === 'success') {
                            this.handleNewRequests(data);
                        } else {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data.error);
                        }
                    } else {
                        console.error('‚ùå –û—à–∏–±–∫–∞ HTTP:', response.status);
                    }
                } catch (error) {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫:', error);
                } finally {
                    this.isChecking = false;
                }
            }

            handleNewRequests(data) {
                const currentCount = data.unviewed_requests_count || 0;
                const newRequests = data.new_requests || [];
                
                console.log(`üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: –ù–µ–ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫ - ${currentCount}`);
                console.log(`üìä –í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫: ${data.all_requests_count || 0}`);
                console.log(`üëÄ –ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö: ${data.viewed_requests_count || 0}`);
                console.log(`üÜï –ù–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫ –ø–æ–ª—É—á–µ–Ω–æ: ${newRequests.length}`);
                
                // üîπ –ï–°–õ–ò –ö–û–õ–ò–ß–ï–°–¢–í–û 0 - –°–ë–†–ê–°–´–í–ê–ï–ú –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
                if (currentCount === 0) {
                    this.resetNotifications();
                    return;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                this.updateHeaderIndicator(currentCount);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫–∏ –µ—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –£–í–ï–õ–ò–ß–ò–õ–û–°–¨
                if (currentCount > this.lastCount && newRequests.length > 0) {
                    const newCount = currentCount - this.lastCount;
                    console.log(`üéØ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∏ –¥–æ–±–∞–≤–ª—è–µ–º ${newCount} –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫`);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    this.showAlert(newCount);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
                    this.addNewRequestsToPage(newRequests);
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
                this.lastCount = currentCount;
            }

            resetNotifications() {
                console.log('üîÑ –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π');
                
                this.lastCount = 0;
                this.updateHeaderIndicator(0);
                this.hideAlert();
                
                // –û—á–∏—â–∞–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
                this.displayedRequests.clear();
            }

            addNewRequestsToPage(newRequests) {
                if (!newRequests.length) {
                    console.log('‚ùå –ù–µ—Ç –∑–∞—è–≤–æ–∫ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
                    return;
                }
                
                console.log('üìù –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É:', newRequests.length);
                console.log('üìã ID –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫:', newRequests.map(req => req.id));
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞—è–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –±—ã–ª–∏ –ø–æ–∫–∞–∑–∞–Ω—ã
                const requestsToShow = newRequests.filter(req => !this.displayedRequests.has(req.id));
                
                console.log('üëÄ –ó–∞—è–≤–∫–∏ –¥–ª—è –ø–æ–∫–∞–∑–∞:', requestsToShow.length);
                console.log('üìä –£–∂–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏:', Array.from(this.displayedRequests));
                
                if (requestsToShow.length === 0) {
                    console.log('‚ÑπÔ∏è –í—Å–µ –Ω–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ —É–∂–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã');
                    return;
                }
                
                const requestsList = document.getElementById('requests-list');
                if (!requestsList) {
                    console.log('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä requests-list –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ');
                    return;
                }
                
                console.log('‚úÖ –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞–π–¥–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫–∏...');
                
                requestsToShow.forEach(requestData => {
                    // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏
                    const requestHtml = this.createRequestHTML(requestData);
                    
                    // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä "–Ω–µ—Ç –∑–∞—è–≤–æ–∫" - —É–¥–∞–ª—è–µ–º –µ–≥–æ
                    const emptyState = requestsList.querySelector('.bg-white.rounded-xl');
                    if (emptyState && emptyState.textContent.includes('–ù–µ—Ç –∑–∞—è–≤–æ–∫')) {
                        console.log('üóëÔ∏è –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç–æ–π state');
                        emptyState.remove();
                    }
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
                    requestsList.insertAdjacentHTML('afterbegin', requestHtml);
                    this.displayedRequests.add(requestData.id);
                    
                    console.log('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—è–≤–∫–∞:', requestData.id);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è
                    setTimeout(() => {
                        const newElement = document.querySelector(`[data-request-id="${requestData.id}"]`);
                        if (newElement) {
                            newElement.classList.add('new-request-highlight', 'pulse-animation');
                            console.log('üé® –î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–Ω–∏–º–∞—Ü–∏—è –¥–ª—è –∑–∞—è–≤–∫–∏:', requestData.id);
                        }
                    }, 100);
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ dashboard (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å)
                this.updateDashboardCounter(requestsToShow.length);
                
                console.log('üéâ –í—Å–µ –∑–∞—è–≤–∫–∏ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã');
            }

            createRequestHTML(requestData) {
                const fileBadge = requestData.has_file ? 
                    `<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full ml-2">üìé –§–∞–π–ª</span>` : '';
                
                const statusBadge = this.getStatusBadge(requestData.status, requestData.status_display);
                const managerInfo = requestData.responsible_manager ? 
                    `<p class="text-gray-600 text-sm"><strong>–ú–µ–Ω–µ–¥–∂–µ—Ä:</strong> ${requestData.responsible_manager}</p>` :
                    `<p class="text-gray-600 text-sm"><strong>–ú–µ–Ω–µ–¥–∂–µ—Ä:</strong> <span class="text-orange-500">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span></p>`;
                
                const description = requestData.description ? 
                    `<div class="bg-gray-50 rounded-lg p-3 mb-3">
                        <p class="text-sm text-gray-700 italic">üìù ${this.truncateText(requestData.description, 200)}</p>
                    </div>` : '';
                
                return `
                <div class="request-item bg-white rounded-xl shadow-sm p-6 border-l-4 border-gold hover:shadow-md transition-all duration-300 relative new-request-appear"
                     data-request-id="${requestData.id}" data-status="${requestData.status}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-2">
                                <h3 class="font-semibold text-lg text-gray-800">${requestData.company_name}</h3>
                                <span class="bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full animate-pulse">
                                    –ù–û–í–ê–Ø
                                </span>
                                ${fileBadge}
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                                <div>
                                    <p class="text-gray-600 text-sm"><strong>–¢–∏–ø –æ–±—ä–µ–∫—Ç–∞:</strong> ${requestData.object_type}</p>
                                    ${requestData.area !== '–ù–µ —É–∫–∞–∑–∞–Ω–∞' ? `<p class="text-gray-600 text-sm"><strong>–ü–ª–æ—â–∞–¥—å:</strong> ${requestData.area} –º¬≤</p>` : ''}
                                </div>
                                <div>
                                    ${managerInfo}
                                    <p class="text-gray-600 text-sm"><strong>–ö–æ–Ω—Ç–∞–∫—Ç:</strong> ${requestData.client_contact}</p>
                                </div>
                            </div>
                            
                            ${description}

                            <p class="text-sm text-gray-600 mb-2">üìç <strong>–ê–¥—Ä–µ—Å:</strong> ${requestData.object_address}</p>
                            
                            ${requestData.has_file ? `
                            <div class="mt-4">
                                <a href="/crm/request/${requestData.id}/download/" 
                                   class="download-btn inline-flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium shadow-sm">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
                                </a>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="flex flex-col items-end gap-3 ml-4">
                            ${statusBadge}
                            
                            <a href="/crm/request/${requestData.id}/" 
                               class="view-request-btn bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                                <span>–ü–æ–¥—Ä–æ–±–Ω–µ–µ</span>
                                <span>‚Üí</span>
                            </a>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center text-xs text-gray-500">
                        <div class="flex items-center gap-4">
                            <span>üìÖ –°–æ–∑–¥–∞–Ω–æ: ${requestData.created_at}</span>
                        </div>
                        
                        {% if is_owner %}
                        <span class="text-orange-500 font-medium">üÜï –ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞!</span>
                        {% endif %}
                    </div>
                </div>
                `;
            }

            getStatusBadge(status, display) {
                const statusClasses = {
                    'new': 'bg-blue-100 text-blue-800 border border-blue-200',
                    'in_progress': 'bg-yellow-100 text-yellow-800 border border-yellow-200',
                    'kp_ready': 'bg-purple-100 text-purple-800 border border-purple-200',
                    'closed': 'bg-green-100 text-green-800 border border-green-200'
                };
                
                const className = statusClasses[status] || 'bg-gray-100 text-gray-800 border border-gray-200';
                
                return `<span class="text-sm px-3 py-1 rounded-full font-medium ${className}">${display}</span>`;
            }

            truncateText(text, length) {
                return text.length > length ? text.substring(0, length) + '...' : text;
            }

            updateDashboardCounter(newCount) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤ dashboard –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
                const newAlert = document.getElementById('new-alert');
                const newCountElement = document.getElementById('new-count');
                
                if (newAlert && newCountElement) {
                    const currentCount = parseInt(newCountElement.textContent) || 0;
                    newCountElement.textContent = currentCount + newCount;
                    newAlert.classList.remove('hidden');
                }
            }

            updateHeaderIndicator(count) {
                if (!this.headerIndicator) return;
                
                if (count > 0) {
                    this.headerCount.textContent = count;
                    this.headerIndicator.classList.remove('hidden');
                    console.log('üî¥ –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ —Ö–µ–¥–µ—Ä–µ:', count);
                } else {
                    this.headerIndicator.classList.add('hidden');
                    console.log('üü¢ –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –≤ —Ö–µ–¥–µ—Ä–µ');
                }
            }

            showAlert(count) {
                if (!this.alertElement || count <= 0) return;
                
                const text = this.getAlertText(count);
                this.alertText.textContent = text;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                this.alertElement.classList.remove('hidden');
                this.alertElement.style.animation = 'slideInRight 0.5s ease-out';
                
                console.log('üîî –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ:', text);
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 8 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    this.hideAlert();
                }, 8000);
            }

            hideAlert() {
                if (this.alertElement && !this.alertElement.classList.contains('hidden')) {
                    this.alertElement.style.animation = 'slideOutRight 0.5s ease-in';
                    setTimeout(() => {
                        this.alertElement.classList.add('hidden');
                        this.alertElement.style.animation = '';
                    }, 500);
                }
            }

            getAlertText(count) {
                if (count === 1) return '1 –Ω–æ–≤–∞—è –∑–∞—è–≤–∫–∞!';
                if (count >= 2 && count <= 4) return `${count} –Ω–æ–≤—ã–µ –∑–∞—è–≤–∫–∏!`;
                return `${count} –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫!`;
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function hideGlobalAlert() {
            const alert = document.getElementById('global-requests-alert');
            if (alert) {
                alert.style.animation = 'slideOutRight 0.5s ease-in';
                setTimeout(() => {
                    alert.classList.add('hidden');
                    alert.style.animation = '';
                }, 500);
            }
        }

        function resetAllNotifications() {
            console.log('üîï –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–±—Ä–æ—Å –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            if (window.globalNotifications) {
                window.globalNotifications.resetNotifications();
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∞–ª–µ—Ä—Ç
            hideGlobalAlert();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∑–∞–ø—É—Å–∫–∞–µ–º —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...');
            window.globalNotifications = new GlobalNotifications();
        });
    </script>

    <!-- üîπ –ë–õ–û–ö –î–õ–Ø –°–ö–†–ò–ü–¢–û–í -->
    {% block scripts %}
    {% endblock %}

    <script>
        lucide.createIcons();
    </script>
</body>
</html>