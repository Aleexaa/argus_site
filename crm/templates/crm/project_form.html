{% extends 'crm/base_crm.html' %}
{% load static %}

{% block title %}{% if project %}Редактирование проекта{% else %}Создание проекта{% endif %} | CRM Аргус{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50/30">
  <!-- Header Section -->
  <div class="bg-white border-b border-gray-100 px-6 py-4">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-blue-500 rounded-xl flex items-center justify-center shadow-sm">
          <i data-lucide="{% if project %}folder-open{% else %}folder-plus{% endif %}" class="w-5 h-5 text-white"></i>
        </div>
        <div>
          <h1 class="text-2xl font-semibold text-gray-900">
            {% if project %}Редактирование проекта{% else %}Создание проекта{% endif %}
          </h1>
          <p class="text-sm text-gray-500 mt-1">
            {% if project %}Изменение информации о проекте{% else %}Добавление нового проекта в портфолио{% endif %}
          </p>
        </div>
      </div>
      
      <a href="/crm/projects/" 
         class="flex items-center gap-2 px-4 py-2.5 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-all duration-200 font-medium">
        <i data-lucide="arrow-left" class="w-4 h-4"></i>
        Назад к проектам
      </a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="p-6">
    <div class="max-w-4xl mx-auto">
      <div class="bg-white rounded-2xl shadow-xs border border-gray-100 p-6">
        <form method="POST" enctype="multipart/form-data" class="space-y-6" id="project-form">
          {% csrf_token %}
          
          {% if messages %}
          <div class="mb-6">
            {% for message in messages %}
            <div class="p-4 rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-700 border border-red-200{% else %}bg-green-100 text-green-700 border border-green-200{% endif %}">
              {{ message }}
            </div>
            {% endfor %}
          </div>
          {% endif %}
          
          <!-- Basic Information -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Project Title -->
            <div class="md:col-span-2">
              <label for="title" class="block text-sm font-medium text-gray-700 mb-2">
                Название проекта *
              </label>
              <input type="text" 
                     id="title" 
                     name="title" 
                     required
                     maxlength="255"
                     class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                     placeholder="Введите название проекта"
                     value="{% if project %}{{ project.title }}{% else %}{{ request.POST.title }}{% endif %}">
            </div>
            
            <!-- Object Type -->
            <div>
              <label for="object_type" class="block text-sm font-medium text-gray-700 mb-2">
                Тип объекта *
              </label>
              <select id="object_type" 
                      name="object_type" 
                      required
                      class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                <option value="">Выберите тип объекта</option>
                <option value="residential" {% if project.object_type == 'residential' or request.POST.object_type == 'residential' %}selected{% endif %}>Жилые комплексы</option>
                <option value="commercial" {% if project.object_type == 'commercial' or request.POST.object_type == 'commercial' %}selected{% endif %}>Торговые центры и офисные здания</option>
                <option value="social" {% if project.object_type == 'social' or request.POST.object_type == 'social' %}selected{% endif %}>Социально-значимые объекты</option>
                <option value="other" {% if project.object_type == 'other' or request.POST.object_type == 'other' %}selected{% endif %}>Без категории</option>
              </select>
            </div>
            
            <!-- Address -->
            <div>
              <label for="address" class="block text-sm font-medium text-gray-700 mb-2">
                Адрес объекта
              </label>
              <input type="text" 
                     id="address" 
                     name="address" 
                     maxlength="255"
                     class="w-full px-4 py-3 bg-white border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                     placeholder="Введите адрес объекта"
                     value="{% if project %}{{ project.address }}{% else %}{{ request.POST.address }}{% endif %}">
            </div>
          </div>
          
          <!-- Image Upload -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">
              Изображение проекта
            </label>
            
            <!-- Текущее изображение (только при редактировании) -->
            {% if project and project.image %}
            <div id="current-image" class="mb-4">
              <p class="text-sm text-gray-600 mb-2">Текущее изображение:</p>
              <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                <img src="{{ project.image.url }}" class="w-20 h-20 object-cover rounded-lg">
                <div class="flex-1">
                  <p class="text-sm font-medium text-gray-900">Текущее изображение</p>
                  <p class="text-xs text-gray-500">Загружено ранее</p>
                </div>
                <button type="button" onclick="removeCurrentImage()" class="text-red-500 hover:text-red-700">
                  <i data-lucide="trash-2" class="w-5 h-5"></i>
                </button>
              </div>
              <input type="hidden" id="remove_current_image" name="remove_current_image" value="false">
            </div>
            {% endif %}
            
            <!-- Область загрузки нового изображения -->
            <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center hover:border-gray-400 transition-all duration-200 cursor-pointer"
                 id="upload-area" {% if project and project.image %}style="display: none;"{% endif %}>
              <i data-lucide="upload" class="w-12 h-12 text-gray-400 mx-auto mb-3"></i>
              <p class="text-sm text-gray-600 mb-2">Перетащите изображение или нажмите для загрузки</p>
              <input type="file" 
                     id="image" 
                     name="image" 
                     accept="image/jpeg,image/jpg,image/png,image/gif"
                     class="hidden">
              <button type="button" onclick="document.getElementById('image').click()" 
                      class="inline-flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all duration-200">
                <i data-lucide="image" class="w-4 h-4"></i>
                <span>Выбрать файл</span>
              </button>
              <p class="text-xs text-gray-500 mt-2">PNG, JPG, JPEG, GIF до 10MB</p>
            </div>
            
            <!-- Превью нового изображения -->
            <div id="image-preview" class="mt-3 hidden">
              <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                <img id="preview" class="w-20 h-20 object-cover rounded-lg">
                <div class="flex-1">
                  <p id="file-name" class="text-sm font-medium text-gray-900"></p>
                  <p id="file-size" class="text-xs text-gray-500"></p>
                </div>
                <button type="button" onclick="removeNewImage()" class="text-red-500 hover:text-red-700">
                  <i data-lucide="x" class="w-5 h-5"></i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Submit Button -->
          <div class="flex gap-3 pt-6 border-t border-gray-100">
            <a href="/crm/projects/" 
               class="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 transition-all duration-200 font-medium text-center">
              Отмена
            </a>
            <button type="submit" 
                    id="submit-btn"
                    class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:from-blue-600 hover:to-blue-700 transition-all duration-200 font-medium flex items-center justify-center gap-2 shadow-lg shadow-blue-500/25">
              <i data-lucide="{% if project %}save{% else %}plus{% endif %}" class="w-4 h-4"></i>
              {% if project %}Сохранить изменения{% else %}Создать проект{% endif %}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
    
    const imageInput = document.getElementById('image');
    const uploadArea = document.getElementById('upload-area');
    const imagePreview = document.getElementById('image-preview');
    const preview = document.getElementById('preview');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const submitBtn = document.getElementById('submit-btn');
    const form = document.getElementById('project-form');

    // Drag and drop для изображения
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('border-blue-500', 'bg-blue-50');
    });

    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('border-blue-500', 'bg-blue-50');
    });

    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('border-blue-500', 'bg-blue-50');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleImageFile(files[0]);
        }
    });

    // Обработчик выбора файла
    imageInput.addEventListener('change', function(e) {
        if (this.files.length > 0) {
            handleImageFile(this.files[0]);
        }
    });

    // Функция обработки файла изображения
    function handleImageFile(file) {
        // Проверка типа файла
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
            showMessage('Допустимые форматы: JPG, JPEG, PNG, GIF', 'error');
            return;
        }

        // Проверка размера файла (10MB)
        if (file.size > 10 * 1024 * 1024) {
            showMessage('Размер изображения не должен превышать 10MB', 'error');
            return;
        }

        // Показываем превью
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            imagePreview.classList.remove('hidden');
            uploadArea.style.display = 'none';
        };
        reader.readAsDataURL(file);
    }

    // Удаление нового изображения
    window.removeNewImage = function() {
        imageInput.value = '';
        imagePreview.classList.add('hidden');
        uploadArea.style.display = 'block';
    }

    // Удаление текущего изображения (при редактировании)
    window.removeCurrentImage = function() {
        const currentImageDiv = document.getElementById('current-image');
        const removeInput = document.getElementById('remove_current_image');
        
        if (currentImageDiv && removeInput) {
            currentImageDiv.style.display = 'none';
            removeInput.value = 'true';
            uploadArea.style.display = 'block';
        }
    }

    // Форматирование размера файла
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Валидация формы
    form.addEventListener('submit', function(e) {
        const title = document.getElementById('title').value.trim();
        const objectType = document.getElementById('object_type').value;

        if (!title) {
            e.preventDefault();
            showMessage('Введите название проекта', 'error');
            document.getElementById('title').focus();
            return;
        }

        if (!objectType) {
            e.preventDefault();
            showMessage('Выберите тип объекта', 'error');
            document.getElementById('object_type').focus();
            return;
        }

        // Показываем индикатор загрузки
        submitBtn.innerHTML = '<i data-lucide="loader" class="w-4 h-4 animate-spin"></i> {% if project %}Сохранение...{% else %}Создание...{% endif %}';
        submitBtn.disabled = true;
    });

    // Функция показа сообщений
    function showMessage(message, type) {
        // Удаляем существующие сообщения
        const existingMessages = document.querySelectorAll('.temp-message');
        existingMessages.forEach(msg => msg.remove());

        const messageDiv = document.createElement('div');
        messageDiv.className = `temp-message fixed top-4 right-4 z-50 px-6 py-4 rounded-2xl shadow-xl border backdrop-blur-sm transform animate-scale-in ${
            type === 'error' 
                ? 'bg-gradient-to-r from-red-50 to-rose-50 border-red-200 text-red-700' 
                : 'bg-gradient-to-r from-green-50 to-emerald-50 border-green-200 text-green-700'
        }`;
        messageDiv.innerHTML = `
            <div class="flex items-center gap-3">
                <i data-lucide="${type === 'error' ? 'alert-circle' : 'check-circle'}" class="w-5 h-5"></i>
                <span class="font-medium">${message}</span>
            </div>
        `;
        document.body.appendChild(messageDiv);
        
        lucide.createIcons();
        
        setTimeout(() => {
            if (messageDiv.parentElement) {
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    if (messageDiv.parentElement) {
                        document.body.removeChild(messageDiv);
                    }
                }, 300);
            }
        }, 5000);
    }
});
</script>

<style>
#upload-area {
    transition: all 0.3s ease;
}

#upload-area.dragover {
    border-color: #3b82f6;
    background-color: #eff6ff;
}

.temp-message {
    animation: slideInRight 0.5s ease-out;
}

@keyframes slideInRight {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}
</style>
{% endblock %}